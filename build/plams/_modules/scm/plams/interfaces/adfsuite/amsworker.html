

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
<META name="ROBOTS" content="NOINDEX, NOFOLLOW">
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>scm.plams.interfaces.adfsuite.amsworker &mdash; PLAMS 2021.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../../../_static/css/theme_tabs.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../../../_static/panels-bootstrap.min.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../../search.html"/>
    <link rel="top" title="PLAMS 2021.1 documentation" href="../../../../../index.html"/>
        <link rel="up" title="Module code" href="../../../../index.html"/> 

  
  <script src="../../../../../_static/js/jquery.min.js"></script>
  <script src="../../../../../_static/js/bootstrap.min.js"></script>
  <script src="../../../../../_static/js/modernizr.min.js"></script>
  <script src="../../../../../_static/js/app.js"></script>
<script type="text/javascript">
</script>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NCRWHZZ');</script>
<!-- End Google Tag Manager -->

</head>

<body class="wy-body-for-nav" role="document">
  <!--STARTNOSOLR-->
  <header class="site-header navbar-fixed-top compact">
      <nav class="main navbar navbar-default">
        <div class="headerbar_container">
          <a role="button" href="/free-trial/" class="btn btn-sm btn-primary">Free trial</a>
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <div class="navbar-brand">
              <a class="logo" href="https://www.scm.com">
                <img class="logo-small" src="https://www.scm.com/wp-content/themes/scm/images/logos/scm-logo-compact.svg" alt="Software for Chemistry &amp; Materials" />
                <img class="logo-full" src="https://www.scm.com/wp-content/themes/scm/images/logos/scm-logo.svg" alt="Software for Chemistry &amp; Materials" />
              </a>
            </div>
          </div>
          <div class="nav-wrapper">
            <div class="collapse navbar-collapse">
              <ul id="menu-primary-navigation" class="nav navbar-nav"><li id="menu-item-40077" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-40077"><a title="Applications" href="https://www.scm.com/applications/">Applications</a></li>
<li id="menu-item-35" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-35"><a title="Products" href="https://www.scm.com/amsterdam-modeling-suite/">Products</a></li>
<li id="menu-item-36" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-36"><a title="Support" href="https://www.scm.com/support/">Support</a></li>
<li id="menu-item-37" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-37"><a title="About us" href="https://www.scm.com/about-us/">About us</a></li>
</ul>                           <span class="search"><a class="menu_search_link" href="https://www.scm.com/search.php"></a><span class="sr-only">Search</span></span>
            </div>
          </div>
        </div>
      </nav>
 </header>
    

   
  <div id="doc-wrapper">
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../../index.html">
          

          
            
            <img src="../../../../../_static/plams_logo.png" class="logo" />
          
          </a>

          
          
  <ul>
      <li class="wy-breadcrumbs-aside">
        
           
           
        
      </li>
  </ul>
 
<!--ENDNOSOLR-->
             <!--STARTNOSOLR-->
<div role="search">
  <form id="rtd-search-form" class="wy-form search-docs-form" action="https://www.scm.com/search.php" method="get">
  <div class="input-group">
    <input type="text" name="search" placeholder="Search PLAMS" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
    <input type="hidden" name="root" value="doctrunk" />


    <input type="hidden" name="cat" value="doc-scripting" />


    <span class="input-group-btn">
			<button type="submit" class="btn btn-primary"><span class="sr-only">Search</span><span class="fa fa-search"></span></button>
		</span>
	</div>
  </form>
</div>
<!--ENDNOSOLR-->
          

          
        </div>
<!--STARTNOSOLR-->
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Table of contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../intro.html#what-is-plams">What is PLAMS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../intro.html#what-can-be-done-with-plams">What can be done with PLAMS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../intro.html#simple-example">Simple example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../intro.html#what-plams-is-not">What PLAMS is <em>not</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../intro.html#about-this-documentation">About this documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../started.html">Getting started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../started.html#library-contents">Library contents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../started.html#installing-plams">Installing PLAMS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../started.html#updating-plams">Updating PLAMS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../started.html#running-plams">Running PLAMS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../started.html#defaults-file">Defaults file</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../started.html#the-launch-script">The launch script</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../started.html#working-folder-location">Working folder location</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../started.html#passing-variables">Passing variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../started.html#importing-past-jobs">Importing past jobs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../started.html#restarting-failed-script">Restarting failed script</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../started.html#multiple-input-scripts">Multiple input scripts</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../components/components.html">Components overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../components/settings.html">Settings</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/settings.html#tree-like-structure">Tree-like structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/settings.html#dot-notation">Dot notation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/settings.html#case-sensitivity">Case sensitivity</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/settings.html#global-settings">Global settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/settings.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../components/jobs.html">Jobs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/jobs.html#preparing-a-job">Preparing a job</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../components/jobs.html#contents-of-job-settings">Contents of job settings</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../components/jobs.html#default-settings">Default settings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/jobs.html#running-a-job">Running a job</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../components/jobs.html#name-conflicts">Name conflicts</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../components/jobs.html#prerun-and-postrun-methods">Prerun and postrun methods</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../components/jobs.html#preview-mode">Preview mode</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/jobs.html#job-api">Job API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/jobs.html#single-jobs">Single jobs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../components/jobs.html#subclassing-singlejob">Subclassing SingleJob</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/jobs.html#multijobs">Multijobs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../components/jobs.html#using-multijob">Using MultiJob</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../components/results.html">Results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/results.html#files-in-the-job-folder">Files in the job folder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/results.html#synchronization-of-parallel-job-executions">Synchronization of parallel job executions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../components/results.html#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/results.html#cleaning-job-folder">Cleaning job folder</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../components/results.html#cleaning-for-multijobs">Cleaning for multijobs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/results.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../components/runners.html">Job runners</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/runners.html#local-job-runner">Local job runner</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/runners.html#remote-job-runner">Remote job runner</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../components/jobmanager.html">Job manager</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/jobmanager.html#rerun-prevention">Rerun prevention</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/jobmanager.html#pickling">Pickling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/jobmanager.html#restarting-scripts">Restarting scripts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/jobmanager.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../components/functions.html">Public functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/functions.html#logging">Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/functions.html#binding-decorators">Binding decorators</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../components/molecule.html">Molecule</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/mol_api.html">Molecule</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../components/mol_api.html#atom-labeling">Atom labeling</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/atombond.html">Atom</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/atombond.html#bond">Bond</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/mol_rdkit.html">RDKit interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/mol_ase.html">ASE interface</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../components/utils.html">Utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/utils.html#periodic-table">Periodic Table</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/utils.html#units">Units</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/utils.html#geometry-tools">Geometry tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/utils.html#file-format-conversion-tools">File format conversion tools</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../components/trajectories.html">Trajectories</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/xyz.html">XYZ trajectory files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../components/xyz.html#xyz-history-files">XYZ history files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/rkf.html">RKF trajectory files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../components/rkf.html#rkf-history-files">RKF history files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../components/dcd.html">DCD trajectory files</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../interfaces/interfaces.html">Interfaces</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../interfaces/amssuite.html">Amsterdam Modeling Suite</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../interfaces/ams.html">AMS driver and engines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/ams.html#preparing-input">Preparing input</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/ams.html#preparing-runscript">Preparing runscript</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/ams.html#molecule-handling">Molecule handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/ams.html#amsjob-api">AMSJob API</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/ams.html#amsresults-api">AMSResults API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../interfaces/amsworker.html">AMS worker</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/amsworker.html#amsworker-api">AMSWorker API</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/amsworker.html#amsworkerresults-api">AMSWorkerResults API</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/amsworker.html#amsworkerpool-api">AMSWorkerPool API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../interfaces/postadf.html">Analysis tools: Densf, FCF, analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../interfaces/kffiles.html">KF files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../interfaces/crs.html">COSMO-RS</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/crs.html#settings">Settings</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/crs.html#settings-with-multiple-compound">Settings with multiple compound</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/crs.html#adf-and-crsjob">ADF and CRSJob</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/crs.html#cosmo-rs-parameters">COSMO-RS Parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/crs.html#data-analyses-and-plotting">Data analyses and plotting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/crs.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../interfaces/adf.html">ADF (pre-2020 version)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/adf.html#preparing-input">Preparing input</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/adf.html#preparing-runscript">Preparing runscript</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/adf.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../interfaces/reaxff.html">ReaxFF (pre-2019 version)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../interfaces/thirdparty.html">Other programs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../interfaces/cp2k.html">CP2K</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/cp2k.html#settings">Settings</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/cp2k.html#molecule-parsing">Molecule parsing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/cp2k.html#loading-jobs">Loading jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/cp2k.html#molecule-loading">Molecule loading</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/cp2k.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../interfaces/crystal.html">Crystal</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/crystal.html#preparing-a-calculation">Preparing a calculation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/crystal.html#molecule-parsing">Molecule parsing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/crystal.html#results-extraction">Results extraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/crystal.html#example">Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/crystal.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../interfaces/dftbplus.html">DFTB+</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/dftbplus.html#preparing-a-calculation">Preparing a calculation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/dftbplus.html#results-extraction">Results extraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/dftbplus.html#example">Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/dftbplus.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../interfaces/dirac.html">Dirac</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/dirac.html#preparing-a-calculation">Preparing a calculation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/dirac.html#results-extraction">Results extraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/dirac.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../interfaces/mopac.html">MOPAC (standalone program)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/mopac.html#preparing-input">Preparing input</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/mopac.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../interfaces/orca.html">ORCA</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/orca.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../interfaces/raspa.html">RASPA</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/raspa.html#input">Input</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/raspa.html#molecule-parsing">Molecule parsing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/raspa.html#loading-jobs">Loading jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../interfaces/raspa.html#api">API</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples/examples.html">Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../examples/examples.html#id1">Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../examples/He2DissociationCurve.html">Helium dimer dissociation curve</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../examples/WaterOptimization.html">Geometry optimization of water</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../examples/ManyJobsInParallel.html">Many jobs in parallel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../examples/BasisSetBenchmark.html">Benchmark accuracy of basis sets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../examples/ExcitationsWorkflow.html">Workflow: filtering molecules based on excitation energies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../examples/ChargeTransferIntegralsADF.html">Charge transfer integrals with ADF</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../examples/gammascan.html">Tuning the range separation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../examples/examples.html#pre-made-recipes">Pre-made recipes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../examples/ams_crs.html">ADF and COSMO-RS workflow</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../examples/adffragment.html">ADF fragment job</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../examples/ReorganizationEnergy.html">Reorganization Energy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../examples/adfnbo.html">NBO with ADF</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../examples/numgrad.html">Numerical gradients</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../examples/numhess.html">Numerical Hessian</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../examples/molecule_gun.html">ReaxFF molecule gun</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../examples/global_minimum.html">Global Minimum Search</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../examples/vibrationASE.html">Vibrational analysis with ASE</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../examples/vibrationASE.html#example">Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../examples/vibrationASE.html#api">API</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../cookbook/cookbook.html">Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../cookbook/cookbook.html#settings-and-input">Settings and input</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../cookbook/cookbook.html#create-an-input-block-with-an-header">Create an input block with an header</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../cookbook/cookbook.html#create-an-empty-input-block">Create an empty input block</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../cookbook/cookbook.html#convert-an-ams-text-input-into-an-ams-job">Convert an AMS text input into an AMS job</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../cookbook/cookbook.html#convert-an-ams-text-input-into-settings-object">Convert an AMS text input into settings object</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../cookbook/cookbook.html#convert-an-ams-run-file-into-an-amsjob">Convert an AMS .run file into an AMSJob</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../cookbook/cookbook.html#specify-paths-to-files-in-the-input">Specify paths to files in the input</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../cookbook/cookbook.html#restart-from-a-previous-job">Restart from a previous job</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../cookbook/cookbook.html#molecules">Molecules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../cookbook/cookbook.html#generate-a-molecule-from-a-smiles-string">Generate a molecule from a SMILES string</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../cookbook/cookbook.html#counting-rings">Counting rings</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../cookbook/cookbook.html#extracting-results">Extracting Results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../cookbook/cookbook.html#directly-from-functions">Directly from Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../cookbook/cookbook.html#examples-total-energy-and-final-structure">Examples: Total Energy and Final Structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../cookbook/cookbook.html#amsresults-api-functions">AMSResults API Functions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../cookbook/cookbook.html#from-the-rkf-interface">From the RKF Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../cookbook/cookbook.html#finding-section-variable-pairs">Finding Section/Variable Pairs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../cookbook/cookbook.html#from-python-directories">From Python Directories</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../cookbook/cookbook.html#kfbrowser">KFBrowser</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../cookbook/cookbook.html#from-molecular-dynamics-trajectories">From molecular dynamics trajectories</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../../cookbook/cookbook.html#general-md-properties">General MD properties</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../../cookbook/cookbook.html#molecules-from-trajectories">Molecules from trajectories</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../cookbook/cookbook.html#accessing-old-jobs">Accessing Old Jobs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../cookbook/cookbook.html#binding-native-plams-jobs">Binding Native PLAMS Jobs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../cookbook/cookbook.html#binding-old-rkf-files">Binding old RKF Files</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../citations.html">Citations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../../index.html">PLAMS</a>
      </nav>
<!--ENDNOSOLR-->

      
      <div class="wy-nav-content">
        <div class="rst-content">
        <!--STARTNOSOLR-->
<div class="header" role="navigation" aria-label="breadcrumbs navigation">
 
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../../PLAMS.html/../../Documentation/index.html">Documentation</a>/</li>
    <li><a href="../../../../../index.html">PLAMS</a>/</li>
      
          <li><a href="../../../../index.html">Module code</a>/</li>
      
    <li class="orange-text">scm.plams.interfaces.adfsuite.amsworker</li>
  </ul>
  <p>
 
</div>
<!--ENDNOSOLR-->
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for scm.plams.interfaces.adfsuite.amsworker</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..molecule.ase</span> <span class="k">import</span> <span class="n">toASE</span>
<span class="kn">from</span> <span class="nn">...core.jobrunner</span> <span class="k">import</span> <span class="n">JobRunner</span>

<span class="n">TMPDIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SCM_TMPDIR&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;SCM_TMPDIR&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="k">else</span> <span class="kc">None</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ctypes</span>
    <span class="kn">import</span> <span class="nn">ctypes.wintypes</span>
    <span class="kn">import</span> <span class="nn">msvcrt</span>

    <span class="n">kernel32</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">WinDLL</span><span class="p">(</span><span class="s2">&quot;kernel32&quot;</span><span class="p">,</span> <span class="n">use_last_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">CheckHandle</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">HANDLE</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">WinError</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">get_last_error</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="n">CreateNamedPipe</span> <span class="o">=</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">CreateNamedPipeW</span>
    <span class="n">CreateNamedPipe</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">HANDLE</span>
    <span class="n">CreateNamedPipe</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_wchar_p</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">DWORD</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span> <span class="o">+</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">]</span>
    <span class="n">CreateNamedPipe</span><span class="o">.</span><span class="n">errcheck</span> <span class="o">=</span> <span class="n">CheckHandle</span>

    <span class="n">PIPE_REJECT_REMOTE_CLIENTS</span> <span class="o">=</span> <span class="mh">0x00000008</span>
    <span class="n">PIPE_ACCESS_DUPLEX</span> <span class="o">=</span> <span class="mh">0x00000003</span>
    <span class="n">PIPE_TYPE_BYTE</span> <span class="o">=</span> <span class="mh">0x00000000</span>
    <span class="n">PIPE_WAIT</span> <span class="o">=</span> <span class="mh">0x00000000</span>
    <span class="n">ERROR_PIPE_CONNECTED</span> <span class="o">=</span> <span class="mi">535</span>

    <span class="k">def</span> <span class="nf">CheckConnect</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">get_last_error</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">error</span> <span class="o">!=</span> <span class="n">ERROR_PIPE_CONNECTED</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">WinError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="n">ConnectNamedPipe</span> <span class="o">=</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">ConnectNamedPipe</span>
    <span class="n">ConnectNamedPipe</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">BOOL</span>
    <span class="n">ConnectNamedPipe</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">]</span>
    <span class="n">ConnectNamedPipe</span><span class="o">.</span><span class="n">errcheck</span> <span class="o">=</span> <span class="n">CheckConnect</span>

    <span class="n">GetConsoleProcessList</span> <span class="o">=</span> <span class="n">kernel32</span><span class="o">.</span><span class="n">GetConsoleProcessList</span>
    <span class="n">GetConsoleProcessList</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">DWORD</span>
    <span class="n">GetConsoleProcessList</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">LPDWORD</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">DWORD</span><span class="p">)</span>


<span class="n">spawn_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ubjson</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">psutil</span>
    <span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AMSWorker&#39;</span><span class="p">,</span> <span class="s1">&#39;AMSWorkerResults&#39;</span><span class="p">,</span> <span class="s1">&#39;AMSWorkerError&#39;</span><span class="p">,</span> <span class="s1">&#39;AMSWorkerPool&#39;</span><span class="p">]</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">__all__</span> <span class="o">=</span> <span class="p">[]</span>

<span class="kn">from</span> <span class="nn">...mol.molecule</span> <span class="k">import</span> <span class="n">Molecule</span>
<span class="kn">from</span> <span class="nn">...core.settings</span> <span class="k">import</span> <span class="n">Settings</span>
<span class="kn">from</span> <span class="nn">...core.errors</span> <span class="k">import</span> <span class="n">PlamsError</span><span class="p">,</span> <span class="n">JobError</span><span class="p">,</span> <span class="n">ResultsError</span>
<span class="kn">from</span> <span class="nn">...tools.units</span> <span class="k">import</span> <span class="n">Units</span>
<span class="kn">from</span> <span class="nn">...core.functions</span> <span class="k">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">.ams</span> <span class="k">import</span> <span class="n">AMSJob</span>
<span class="kn">from</span> <span class="nn">.amspipeerror</span> <span class="k">import</span> <span class="o">*</span>


<span class="k">def</span> <span class="nf">_restrict</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator that wraps methods of |AMSWorkerResults| instances.</span>

<span class="sd">    This is used to replicate the behaviour of the full |AMSResults| object: Access to the values in an |AMSWorkerResults| instance will first check if the calculation leading to the results finish correctly and raise a |ResultsError| error exception if this is not the case. This behaviour can be modified with the ``config.ignore_failure`` setting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">guardian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">ignore_failure</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="s1">&#39;WARNING: Trying to obtain results of a failed calculation </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Obtaining results of </span><span class="si">{}</span><span class="s1"> failed. Returned value is None&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Obtaining results of </span><span class="si">{}</span><span class="s1"> successful. However, no guarantee that they make sense&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ret</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ResultsError</span><span class="p">(</span><span class="s1">&#39;Using Results obtained from a failed calculation&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">guardian</span>



<div class="viewcode-block" id="AMSWorkerResults"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerResults">[docs]</a><span class="k">class</span> <span class="nc">AMSWorkerResults</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A specialized class encapsulating the results from calls to an |AMSWorker|.</span>

<span class="sd">    .. technical::</span>

<span class="sd">        AMSWorkerResults is *not* a subclass of |Results| or |AMSResults|. It does however implement some commonly used methods of the |AMSResults| class, so that results calculated by |AMSJob| and |AMSWorker| can be accessed in a uniform way.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>           <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_molecule</span> <span class="o">=</span> <span class="n">molecule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span>           <span class="o">=</span> <span class="n">error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span>        <span class="o">=</span> <span class="n">results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_main_molecule</span>  <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_main_ase_atoms</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The name of a calculation.</span>

<span class="sd">        That is the name that was passed into the |AMSWorker| method when this |AMSWorkerResults| object was created. I can not be changed after the |AMSWorkerResults| instance has been created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ResultsError</span><span class="p">(</span><span class="s1">&#39;The name attribute of AMSWorkerResults may not be changed.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="AMSWorkerResults.ok"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerResults.ok">[docs]</a>    <span class="k">def</span> <span class="nf">ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if the calculation was successful. If not, the ``error`` attribute contains a corresponding exception.</span>

<span class="sd">        Users should check if the calculation was successful before using the other methods of the |AMSWorkerResults| instance, as using them might raise a |ResultsError| exception otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AMSWorkerResults.get_errormsg"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerResults.get_errormsg">[docs]</a>    <span class="k">def</span> <span class="nf">get_errormsg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempts to retreive a human readable error message from a crashed job. Returns ``None`` for jobs without errors.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s1">&#39;ERROR: &#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;ERROR: &#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;Could not determine error message. Please check the error.stdout and error.stderr manually.&#39;</span></div>

<div class="viewcode-block" id="AMSWorkerResults.get_energy"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerResults.get_energy">[docs]</a>    <span class="nd">@_restrict</span>
    <span class="k">def</span> <span class="nf">get_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;au&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the total energy, expressed in *unit*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">Units</span><span class="o">.</span><span class="n">conversion_ratio</span><span class="p">(</span><span class="s1">&#39;au&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span></div>

<div class="viewcode-block" id="AMSWorkerResults.get_gradients"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerResults.get_gradients">[docs]</a>    <span class="nd">@_restrict</span>
    <span class="k">def</span> <span class="nf">get_gradients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy_unit</span><span class="o">=</span><span class="s1">&#39;au&#39;</span><span class="p">,</span> <span class="n">dist_unit</span><span class="o">=</span><span class="s1">&#39;au&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the nuclear gradients of the total energy, expressed in *energy_unit* / *dist_unit*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s2">&quot;gradients&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">Units</span><span class="o">.</span><span class="n">conversion_ratio</span><span class="p">(</span><span class="s1">&#39;au&#39;</span><span class="p">,</span> <span class="n">energy_unit</span><span class="p">)</span> <span class="o">/</span> <span class="n">Units</span><span class="o">.</span><span class="n">conversion_ratio</span><span class="p">(</span><span class="s1">&#39;au&#39;</span><span class="p">,</span> <span class="n">dist_unit</span><span class="p">)</span></div>

<div class="viewcode-block" id="AMSWorkerResults.get_stresstensor"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerResults.get_stresstensor">[docs]</a>    <span class="nd">@_restrict</span>
    <span class="k">def</span> <span class="nf">get_stresstensor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the clamped-ion stress tensor, expressed in atomic units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s2">&quot;stressTensor&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="AMSWorkerResults.get_hessian"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerResults.get_hessian">[docs]</a>    <span class="nd">@_restrict</span>
    <span class="k">def</span> <span class="nf">get_hessian</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the Hessian matrix, i.e. the second derivative of the total energy with respect to the nuclear coordinates, expressed in atomic units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s2">&quot;hessian&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="AMSWorkerResults.get_elastictensor"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerResults.get_elastictensor">[docs]</a>    <span class="nd">@_restrict</span>
    <span class="k">def</span> <span class="nf">get_elastictensor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the elastic tensor, expressed in atomic units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s2">&quot;elasticTensor&quot;</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">get_youngmodulus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;au&#39;</span><span class="p">):</span>
        <span class="n">bm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bulkmodulus</span><span class="p">()</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shearmodulus</span><span class="p">()</span>
        <span class="n">ym</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="o">*</span><span class="n">bm</span><span class="o">*</span><span class="n">sm</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">bm</span><span class="o">+</span><span class="n">sm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ym</span> <span class="o">*</span> <span class="n">Units</span><span class="o">.</span><span class="n">conversion_ratio</span><span class="p">(</span><span class="s1">&#39;au&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_shearmodulus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;au&#39;</span><span class="p">):</span>
        <span class="n">et</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elastictensor</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">et</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ResultsError</span><span class="p">(</span><span class="s1">&#39;Elastic moduli can only be calculated for bulk systems.&#39;</span><span class="p">)</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="p">((</span><span class="n">et</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">et</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">et</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">et</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">et</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">et</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">et</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">et</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">et</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">]))</span> <span class="o">/</span> <span class="mi">15</span>
        <span class="k">return</span> <span class="n">sm</span> <span class="o">*</span> <span class="n">Units</span><span class="o">.</span><span class="n">conversion_ratio</span><span class="p">(</span><span class="s1">&#39;au&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_bulkmodulus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;au&#39;</span><span class="p">):</span>
        <span class="n">et</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elastictensor</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">et</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ResultsError</span><span class="p">(</span><span class="s1">&#39;Elastic moduli can only be calculated for bulk systems.&#39;</span><span class="p">)</span>
        <span class="n">bm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">et</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mi">9</span>
        <span class="k">return</span> <span class="n">bm</span> <span class="o">*</span> <span class="n">Units</span><span class="o">.</span><span class="n">conversion_ratio</span><span class="p">(</span><span class="s1">&#39;au&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>

<div class="viewcode-block" id="AMSWorkerResults.get_charges"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerResults.get_charges">[docs]</a>    <span class="nd">@_restrict</span>
    <span class="k">def</span> <span class="nf">get_charges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the atomic charges, expressed in atomic units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s2">&quot;charges&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="AMSWorkerResults.get_dipolemoment"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerResults.get_dipolemoment">[docs]</a>    <span class="nd">@_restrict</span>
    <span class="k">def</span> <span class="nf">get_dipolemoment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the electric dipole moment, expressed in atomic units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s2">&quot;dipoleMoment&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="AMSWorkerResults.get_dipolegradients"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerResults.get_dipolegradients">[docs]</a>    <span class="nd">@_restrict</span>
    <span class="k">def</span> <span class="nf">get_dipolegradients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the nuclear gradients of the electric dipole moment, expressed in atomic units. This is a (3*numAtoms x 3) matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s2">&quot;dipoleGradients&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="AMSWorkerResults.get_input_molecule"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerResults.get_input_molecule">[docs]</a>    <span class="k">def</span> <span class="nf">get_input_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a |Molecule| instance with the coordinates passed into the |AMSWorker|.</span>

<span class="sd">        Note that this method may also be used if the calculation producing this |AMSWorkerResults| object has failed, i.e. :meth:`ok` is ``False``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_molecule</span></div>

<div class="viewcode-block" id="AMSWorkerResults.get_main_molecule"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerResults.get_main_molecule">[docs]</a>    <span class="nd">@_restrict</span>
    <span class="k">def</span> <span class="nf">get_main_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a |Molecule| instance with the final coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_main_molecule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;xyzAtoms&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_main_molecule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_molecule</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_main_molecule</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xyzAtoms&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">Units</span><span class="o">.</span><span class="n">conversion_ratio</span><span class="p">(</span><span class="s1">&#39;au&#39;</span><span class="p">,</span> <span class="s1">&#39;Angstrom&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="s1">&#39;latticeVectors&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_main_molecule</span><span class="o">.</span><span class="n">lattice</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;latticeVectors&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">Units</span><span class="o">.</span><span class="n">conversion_ratio</span><span class="p">(</span><span class="s1">&#39;au&#39;</span><span class="p">,</span> <span class="s1">&#39;Angstrom&#39;</span><span class="p">)</span> <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_main_molecule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_molecule</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_main_molecule</span></div>

<div class="viewcode-block" id="AMSWorkerResults.get_main_ase_atoms"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerResults.get_main_ase_atoms">[docs]</a>    <span class="nd">@_restrict</span>
    <span class="k">def</span> <span class="nf">get_main_ase_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an ASE Atoms instance with the final coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ase</span> <span class="k">import</span> <span class="n">Atoms</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_main_ase_atoms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;xyzAtoms&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">:</span>
                <span class="n">bohr2angstrom</span> <span class="o">=</span> <span class="mf">0.529177210903</span>
                <span class="n">lattice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;latticeVectors&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">pbc</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">lattice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">nLatticeVectors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lattice</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nLatticeVectors</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">pbc</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">nLatticeVectors</span> <span class="o">+</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="n">nLatticeVectors</span><span class="p">)</span>
                        <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                        <span class="n">lattice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lattice</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                        <span class="n">cell</span><span class="p">[:</span><span class="n">lattice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:</span><span class="n">lattice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">lattice</span> <span class="o">*</span> <span class="n">bohr2angstrom</span>
                <span class="n">atomsymbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_molecule</span><span class="p">]</span>
                <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;xyzAtoms&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">bohr2angstrom</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_main_ase_atoms</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">(</span><span class="n">symbols</span><span class="o">=</span><span class="n">atomsymbols</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span> <span class="n">pbc</span><span class="o">=</span><span class="n">pbc</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="n">cell</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_main_ase_atoms</span> <span class="o">=</span> <span class="n">toASE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_main_molecule</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_main_ase_atoms</span></div></div>


<span class="k">class</span> <span class="nc">AMSWorkerError</span><span class="p">(</span><span class="n">PlamsError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Error related to an AMSWorker process.</span>

<span class="sd">    The output from the failed worker process is stored in the ``stdout`` and ``stderr`` attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">get_errormsg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;ERROR: &#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;ERROR: &#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Could not determine error message. Please check the error.stdout and error.stderr manually.&#39;</span>



<span class="n">_arg2setting</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;prev_results&quot;</span><span class="p">,</span> <span class="s2">&quot;quiet&quot;</span><span class="p">):</span>
    <span class="n">_arg2setting</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;amsworker&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;gradients&quot;</span><span class="p">,</span> <span class="s2">&quot;stresstensor&quot;</span><span class="p">,</span> <span class="s2">&quot;hessian&quot;</span><span class="p">,</span> <span class="s2">&quot;elastictensor&quot;</span><span class="p">,</span> <span class="s2">&quot;charges&quot;</span><span class="p">,</span> <span class="s2">&quot;dipolemoment&quot;</span><span class="p">,</span> <span class="s2">&quot;dipolegradients&quot;</span><span class="p">):</span>
    <span class="n">_arg2setting</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;ams&#39;</span><span class="p">,</span> <span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;coordinatetype&quot;</span><span class="p">,</span> <span class="s2">&quot;optimizelattice&quot;</span><span class="p">,</span> <span class="s2">&quot;maxiterations&quot;</span><span class="p">,</span> <span class="s2">&quot;pretendconverged&quot;</span><span class="p">,</span> <span class="s2">&quot;calcpropertiesonlyifconverged&quot;</span><span class="p">):</span>
    <span class="n">_arg2setting</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;ams&#39;</span><span class="p">,</span> <span class="s1">&#39;geometryoptimization&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;convenergy&quot;</span><span class="p">,</span> <span class="s2">&quot;convgradients&quot;</span><span class="p">,</span> <span class="s2">&quot;convstep&quot;</span><span class="p">,</span> <span class="s2">&quot;convstressenergyperatom&quot;</span><span class="p">):</span>
    <span class="n">_arg2setting</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;ams&#39;</span><span class="p">,</span> <span class="s1">&#39;geometryoptimization&#39;</span><span class="p">,</span> <span class="s1">&#39;convergence&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>

<span class="n">_arg2setting</span><span class="p">[</span><span class="s1">&#39;task&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;ams&#39;</span><span class="p">,</span> <span class="s1">&#39;task&#39;</span><span class="p">)</span>
<span class="n">_arg2setting</span><span class="p">[</span><span class="s1">&#39;usesymmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;ams&#39;</span><span class="p">,</span> <span class="s1">&#39;usesymmetry&#39;</span><span class="p">)</span>
<span class="n">_arg2setting</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;ams&#39;</span><span class="p">,</span> <span class="s1">&#39;geometryoptimization&#39;</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">)</span>

<span class="n">_setting2arg</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">_arg2setting</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>


<div class="viewcode-block" id="AMSWorker"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorker">[docs]</a><span class="k">class</span> <span class="nc">AMSWorker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A class representing a running instance of the AMS driver as a worker process.</span>

<span class="sd">    Users need to supply a |Settings| instance representing the input of the AMS driver process (see :ref:`AMS_preparing_input`), but **not including** the ``Task`` keyword in the input (the ``input.ams.Task`` key in the |Settings| instance). The |Settings| instance should also not contain a system specification in the ``input.ams.System`` block, the ``input.ams.Properties`` block, or the ``input.ams.GeometryOptimization`` block. Often the settings of the AMS driver in worker mode will come down to just the engine block.</span>

<span class="sd">    The AMS driver will then start up as a worker, communicating with PLAMS via named pipes created in a temporary directory (determined by the *workerdir_root* and *workerdir_prefix* arguments). This temporary directory might also contain temporary files used by the worker process. Note that while an |AMSWorker| instance exists, the associated worker process can be assumed to be running and ready: If it crashes for some reason, it is automatically restarted.</span>

<span class="sd">    The recommended way to start an |AMSWorker| is as a context manager:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        with AMSWorker(settings) as worker:</span>
<span class="sd">            results = worker.SinglePoint(&#39;my_calculation&#39;, molecule)</span>
<span class="sd">        # clean up happens automatically when leaving the block</span>

<span class="sd">    If it is not possible to use the |AMSWorker| as a context manager, cleanup should be manually triggered by calling the :meth:`stop` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">workerdir_root</span><span class="o">=</span><span class="n">TMPDIR</span><span class="p">,</span> <span class="n">workerdir_prefix</span><span class="o">=</span><span class="s1">&#39;amsworker&#39;</span><span class="p">,</span> <span class="n">use_restart_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">keep_crashed_workerdir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reuse_system</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">PyProtVersion</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_restart_cache</span> <span class="o">=</span> <span class="n">use_restart_cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reuse_system</span> <span class="o">=</span> <span class="n">reuse_system</span>

        <span class="c1"># We&#39;ll initialize these communication related variables to None for now.</span>
        <span class="c1"># They will be overwritten when we actually start things up, but we do</span>
        <span class="c1"># not want them to be undefined for now, just in case of errors ...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proc</span>      <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callpipe</span>  <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replypipe</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">restart_cache</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_cache_deleted</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Check if the settings we have are actually suitable for a PipeWorker.</span>
        <span class="c1"># They should not contain certain keywords and blocks.</span>
        <span class="k">if</span> <span class="s1">&#39;ams&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;Task&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ams</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Settings for AMSWorker should not contain a Task&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;System&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ams</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Settings for AMSWorker should not contain a System block&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;Properties&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ams</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Settings for AMSWorker should not contain the Properties block&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;GeometryOptimization&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ams</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Settings for AMSWorker should not contain the GeometryOptimization block&#39;</span><span class="p">)</span>

        <span class="c1"># Make a copy of the Settings instance so we do not modify the outside world and fix the task to be &quot;Pipe&quot;.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ams</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="s1">&#39;pipe&#39;</span>

        <span class="c1"># Create the directory in which we will run the worker.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wd_root</span>   <span class="o">=</span> <span class="n">workerdir_root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wd_prefix</span> <span class="o">=</span> <span class="n">workerdir_prefix</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wd_root</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wd_prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalization</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_wd</span>   <span class="o">=</span> <span class="n">keep_crashed_workerdir</span>

        <span class="c1"># Start the worker process.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_subprocess</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">_start_subprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># We will use the standard PLAMS AMSJob class to prepare our input and runscript.</span>
        <span class="n">amsjob</span> <span class="o">=</span> <span class="n">AMSJob</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;amsworker&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">,</span> <span class="s1">&#39;amsworker.in&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">input_file</span><span class="p">:</span>
            <span class="n">input_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">amsjob</span><span class="o">.</span><span class="n">get_input</span><span class="p">())</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">,</span> <span class="s1">&#39;amsworker.run&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">runscript</span><span class="p">:</span>
            <span class="n">runscript</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">amsjob</span><span class="o">.</span><span class="n">get_runscript</span><span class="p">())</span>
        <span class="k">del</span> <span class="n">amsjob</span>

        <span class="c1"># Create the named pipes for communication.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pipe_name</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">.\pipe\</span><span class="si">{}</span><span class="s2">_amspipe&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
                        <span class="nb">str</span><span class="o">.</span><span class="n">maketrans</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;:\/&quot;</span><span class="p">,</span> <span class="s2">&quot;___&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="n">CreateNamedPipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pipe_name</span><span class="p">,</span> <span class="n">PIPE_ACCESS_DUPLEX</span><span class="p">,</span>
                                   <span class="n">PIPE_TYPE_BYTE</span> <span class="o">|</span> <span class="n">PIPE_REJECT_REMOTE_CLIENTS</span> <span class="o">|</span> <span class="n">PIPE_WAIT</span><span class="p">,</span>
                                   <span class="mi">1</span><span class="p">,</span>            <span class="c1"># Maximum number of instances</span>
                                   <span class="mi">65536</span><span class="p">,</span> <span class="mi">65536</span><span class="p">,</span> <span class="c1"># Output and input buffers in bytes</span>
                                   <span class="mi">60000</span><span class="p">,</span>        <span class="c1"># Timeout in ms (unused unless someone calls Wait)</span>
                                   <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;call_pipe&quot;</span><span class="p">,</span> <span class="s2">&quot;reply_pipe&quot;</span><span class="p">]:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkfifo</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>

        <span class="c1"># Launch the worker process</span>

        <span class="c1"># spawn_lock is needed on Windows to workaround https://bugs.python.org/issue19575</span>
        <span class="c1"># Without it, multiple AMSWorkers in a pool would call Popen() simultaneously,</span>
        <span class="c1"># causing all the worker processes to inherit all the stdin/out/err file handles,</span>
        <span class="c1"># creating a huge mess and preventing the deletion of these files when a worker quits.</span>
        <span class="c1"># We can use spawn_lock on all platforms for simplicity without hurting performance</span>
        <span class="c1"># because most of the work is serialized in the kernel anyway.</span>
        <span class="k">with</span> <span class="n">spawn_lock</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">,</span> <span class="s1">&#39;amsworker.in&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">amsinput</span><span class="p">,</span> \
                 <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">,</span> <span class="s1">&#39;ams.out&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">amsoutput</span><span class="p">,</span> \
                 <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">,</span> <span class="s1">&#39;ams.err&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">amserror</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;sh&#39;</span><span class="p">,</span> <span class="s1">&#39;amsworker.run&#39;</span><span class="p">],</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">,</span>
                                             <span class="n">stdout</span><span class="o">=</span><span class="n">amsoutput</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">amsinput</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">amserror</span><span class="p">,</span>
                                             <span class="c1"># Put all worker processes into a dedicated process group</span>
                                             <span class="c1"># to enable mass-killing in stop().</span>
                                             <span class="n">start_new_session</span><span class="o">=</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;posix&#39;</span><span class="p">),</span>
                                             <span class="n">creationflags</span><span class="o">=</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CREATE_NEW_PROCESS_GROUP</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                                             <span class="p">)</span>

        <span class="c1"># Start a dedicated watcher thread to rescue us in case the worker never opens its end of the pipes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_watcher</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_watcher</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_startup_watcher</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">],</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_watcher</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c1"># This will block until either the worker is ready or the watcher steps in.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>
                <span class="n">ConnectNamedPipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">pipefd</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">open_osfhandle</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">callpipe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">pipefd</span><span class="p">,</span> <span class="s1">&#39;r+b&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">replypipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callpipe</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">callpipe</span>  <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">,</span> <span class="s1">&#39;call_pipe&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">replypipe</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">,</span> <span class="s1">&#39;reply_pipe&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Both open()s are either done or have failed, we don&#39;t need the watcher thread anymore.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_watcher</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_watcher</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="c1"># Raise a nice error message if the worker failed to start. Otherwise, we&#39;d get</span>
        <span class="c1"># a less descriptive error from the call to Hello below.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_process</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">AMSWorkerError</span><span class="p">(</span><span class="s1">&#39;AMSWorker process did not start up correctly&#39;</span><span class="p">)</span>

            <span class="c1"># Now everything should be ready. Let&#39;s try saying Hello via the pipes ...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">PyProtVersion</span><span class="p">})</span>
        <span class="k">except</span> <span class="n">AMSWorkerError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">exc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">raise</span>


    <span class="k">def</span> <span class="nf">_startup_watcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workerdir</span><span class="p">):</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_watcher</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
                <span class="c1"># self.proc has died and won&#39;t open its end of the pipes ...</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_watcher</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="c1"># ... but the main thread is still expecting someone to do it.</span>
                    <span class="c1"># Let&#39;s do it ourselves to unblock our main thread.</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pipe_name</span><span class="p">,</span> <span class="s1">&#39;r+b&#39;</span><span class="p">):</span>
                            <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workerdir</span><span class="p">,</span> <span class="s1">&#39;call_pipe&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span> \
                            <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workerdir</span><span class="p">,</span> <span class="s1">&#39;reply_pipe&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">):</span>
                            <span class="c1"># Nothing to do here, just close the pipes again.</span>
                            <span class="k">pass</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
                <span class="c1"># self.proc is still alive.</span>
                <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>


    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">_find_worker_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># This is a convoluted workaround for the fact that the MSYS sh.exe on Windows likes to</span>
            <span class="c1"># launch commands as detached grandchildren, not direct children, so we can&#39;t track them</span>
            <span class="c1"># down just by following PPIDs. We thus have to resort to heuristics to find all processes</span>
            <span class="c1"># that we need to kill. It&#39;d be best to use Win32 Job objects for this, but the &quot;subprocess&quot;</span>
            <span class="c1"># module doesn&#39;t let us add the created child to a Job early enough.</span>

            <span class="c1"># Get the PIDs of all processes sharing this console.</span>
            <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">1024</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">console_pids</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">DWORD</span> <span class="o">*</span> <span class="n">bufsize</span><span class="p">)()</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">GetConsoleProcessList</span><span class="p">(</span><span class="n">console_pids</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">WinError</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">get_last_error</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">bufsize</span><span class="p">:</span>
                    <span class="n">bufsize</span> <span class="o">*=</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="c1"># Convert PIDs to Process objects ASAP to minimize the potential for races with PID reuse.</span>
            <span class="n">console_procs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">console_pids</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">console_procs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
                    <span class="c1"># The process exited in the meantime or we can&#39;t access it, just skip it.</span>
                    <span class="k">pass</span>

            <span class="c1"># Find all &quot;(ba)sh.exe&quot; processes on this console that are running in self.workerdir</span>
            <span class="c1"># and add them to worker_procs including all descendants.</span>
            <span class="n">worker_procs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">console_procs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">worker_procs</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">exe</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;sh.exe&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">proc</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">:</span>
                        <span class="n">worker_procs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
                        <span class="n">worker_procs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">return</span> <span class="n">worker_procs</span>


<div class="viewcode-block" id="AMSWorker.stop"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorker.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_workerdir</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stops the worker process and removes its working directory.</span>

<span class="sd">        This method should be called when the |AMSWorker| instance is not used as a context manager and the instance is no longer needed. Otherwise proper cleanup is not guaranteed to happen, the worker process might be left running and files might be left on disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stdout</span>  <span class="o">=</span> <span class="kc">None</span>
        <span class="n">stderr</span>  <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Tell the worker process to stop.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_process</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="s2">&quot;Exit&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">AMSWorkerError</span><span class="p">:</span>
                    <span class="c1"># The process is likely exiting already.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_wd</span><span class="p">:</span>
                        <span class="n">keep_workerdir</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;AMSWorkerError encountered, will keep the workerdir in </span><span class="si">{self.workerdir}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Tear down the pipes. Ignore OSError telling us the pipes are already broken.</span>
        <span class="c1"># This will also make the worker exit if it didn&#39;t get the Exit message above.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callpipe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">callpipe</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">callpipe</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callpipe</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">replypipe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">replypipe</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">replypipe</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">replypipe</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Now that the pipes are down, the worker should certainly be exiting.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>
                    <span class="n">worker_procs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_worker_processes</span><span class="p">()</span>
                    <span class="c1"># Send Ctrl-Break to the entire process group under self.proc.</span>
                    <span class="c1"># Ctrl-C is less reliable in convincing processes to quit.</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">CTRL_BREAK_EVENT</span><span class="p">)</span>
                    <span class="n">dead</span><span class="p">,</span> <span class="n">alive</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">wait_procs</span><span class="p">(</span><span class="n">worker_procs</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">alive</span><span class="p">:</span>
                        <span class="c1"># Forcefully kill any descendant that is still running.</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                    <span class="n">psutil</span><span class="o">.</span><span class="n">wait_procs</span><span class="p">(</span><span class="n">alive</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Using SIGINT guarantees that the &quot;sh&quot; we&#39;re running as self.proc (and the &quot;sh&quot; running</span>
                    <span class="c1"># the start script etc.) will wait until its children have exited before exiting itself.</span>
                    <span class="c1"># The wait() thus doesn&#39;t return until all the descendants including ams.exe are gone.</span>
                    <span class="c1"># If we used SIGTERM instead, the &quot;sh&quot;s would exit immediately.</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">killpg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
                        <span class="c1"># This is guaranteed to stop everything, so we don&#39;t really have to wait for all processes.</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">killpg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">,</span> <span class="s1">&#39;ams.out&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">amsoutput</span><span class="p">:</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="n">amsoutput</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">,</span> <span class="s1">&#39;ams.err&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">amserror</span><span class="p">:</span>
                <span class="n">stderr</span> <span class="o">=</span> <span class="n">amserror</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="c1"># At this point the worker is down. We definitely don&#39;t have anything in the restart cache anymore ...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_cache_deleted</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">keep_workerdir</span><span class="p">:</span>
            <span class="c1"># Keep the current workerdir and move to a new one</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_finalization</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wd_root</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wd_prefix</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_finalization</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Remove the contents of the worker directory.</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workerdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">_delete_from_restart_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_cache</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_cache_deleted</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_prune_restart_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_cache_deleted</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="s2">&quot;DeleteResults&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_cache_deleted</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_supports_settings</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="n">Settings</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check if a |Settings| object is supported by |AMSWorker|.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">AMSWorker</span><span class="o">.</span><span class="n">_settings_to_args</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_settings_to_args</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="n">Settings</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span> <span class="p">]:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a `tuple(TASK, **request_kwargs)` corresponding to a given settings object.</span>

<span class="sd">        Raises NotImplementedError if unsupported features are encountered.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">kl</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">key</span> <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="n">_setting2arg</span><span class="p">[</span><span class="n">kl</span><span class="p">]]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unexpected key </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">)))</span>

        <span class="k">if</span> <span class="s2">&quot;task&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No Settings.input.ams.task found&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;task&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;singlepoint&quot;</span><span class="p">,</span> <span class="s2">&quot;geometryoptimization&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unexpected task </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;task&quot;</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">args</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_args_to_settings</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Settings</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">s</span><span class="o">.</span><span class="n">set_nested</span><span class="p">(</span><span class="n">_arg2setting</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>


    <span class="k">def</span> <span class="nf">_solve_from_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">AMSWorker</span><span class="o">.</span><span class="n">_settings_to_args</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;task&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;geometryoptimization&#39;</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;gradients&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># need to explicitly set gradients to True to get them in the AMSWorkerReults</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimizelattice&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;stresstensor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solve</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">prev_results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">gradients</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stresstensor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hessian</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">elastictensor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">charges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dipolemoment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dipolegradients</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coordinatetype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">usesymmetry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optimizelattice</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">maxiterations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pretendconverged</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">calcpropertiesonlyifconverged</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">convenergy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">convgradients</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">convstep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">convstressenergyperatom</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_restart_cache</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_cache</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Name &quot;</span><span class="si">{name}</span><span class="s1">&quot; is already associated with results from the restart cache.&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="c1"># This is a good opportunity to let the worker process know about all the results we no longer need ...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prune_restart_cache</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reuse_system</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_restart_cache</span> <span class="ow">and</span> <span class="n">prev_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_results</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_cache</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="s1">&#39;SetCoords&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;coords&quot;</span><span class="p">:</span> <span class="n">molecule</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span> <span class="o">*</span> <span class="n">Units</span><span class="o">.</span><span class="n">conversion_ratio</span><span class="p">(</span><span class="s1">&#39;Angstrom&#39;</span><span class="p">,</span><span class="s1">&#39;Bohr&#39;</span><span class="p">)})</span>
                <span class="k">if</span> <span class="n">molecule</span><span class="o">.</span><span class="n">lattice</span><span class="p">:</span>
                    <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">lattice</span><span class="p">)</span> <span class="o">*</span> <span class="n">Units</span><span class="o">.</span><span class="n">conversion_ratio</span><span class="p">(</span><span class="s1">&#39;Angstrom&#39;</span><span class="p">,</span><span class="s1">&#39;Bohr&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="s2">&quot;SetLattice&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;vectors&quot;</span><span class="p">:</span> <span class="n">cell</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="s2">&quot;SetLattice&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">chemicalSystem</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">chemicalSystem</span><span class="p">[</span><span class="s1">&#39;atomSymbols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">molecule</span><span class="p">])</span>
                <span class="n">chemicalSystem</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span> <span class="o">*</span> <span class="n">Units</span><span class="o">.</span><span class="n">conversion_ratio</span><span class="p">(</span><span class="s1">&#39;Angstrom&#39;</span><span class="p">,</span><span class="s1">&#39;Bohr&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;charge&#39;</span> <span class="ow">in</span> <span class="n">molecule</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
                    <span class="n">chemicalSystem</span><span class="p">[</span><span class="s1">&#39;totalCharge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">chemicalSystem</span><span class="p">[</span><span class="s1">&#39;totalCharge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">properties</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">suffix</span> <span class="k">if</span> <span class="s1">&#39;suffix&#39;</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">properties</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">molecule</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">properties</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
                    <span class="n">chemicalSystem</span><span class="p">[</span><span class="s1">&#39;atomicInfo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">molecule</span><span class="o">.</span><span class="n">lattice</span><span class="p">:</span>
                    <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">lattice</span><span class="p">)</span> <span class="o">*</span> <span class="n">Units</span><span class="o">.</span><span class="n">conversion_ratio</span><span class="p">(</span><span class="s1">&#39;Angstrom&#39;</span><span class="p">,</span><span class="s1">&#39;Bohr&#39;</span><span class="p">)</span>
                    <span class="n">chemicalSystem</span><span class="p">[</span><span class="s2">&quot;latticeVectors&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">cell</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>    
                    <span class="n">chemicalSystem</span><span class="p">[</span><span class="s1">&#39;bonds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">iat</span> <span class="k">for</span> <span class="n">iat</span> <span class="ow">in</span> <span class="n">molecule</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">bond</span><span class="p">)]</span> <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">molecule</span><span class="o">.</span><span class="n">bonds</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chemicalSystem</span><span class="p">[</span><span class="s1">&#39;bonds&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                        <span class="n">chemicalSystem</span><span class="p">[</span><span class="s1">&#39;bonds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">chemicalSystem</span><span class="p">[</span><span class="s1">&#39;bondOrders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">order</span><span class="p">)</span> <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">molecule</span><span class="o">.</span><span class="n">bonds</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="s2">&quot;SetSystem&quot;</span><span class="p">,</span> <span class="n">chemicalSystem</span><span class="p">)</span>

            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">},</span>
                <span class="s2">&quot;keepResults&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_restart_cache</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">quiet</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">][</span><span class="s2">&quot;quiet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">gradients</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">][</span><span class="s2">&quot;gradients&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">stresstensor</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">][</span><span class="s2">&quot;stressTensor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">hessian</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">][</span><span class="s2">&quot;hessian&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">elastictensor</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">][</span><span class="s2">&quot;elasticTensor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">charges</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">][</span><span class="s2">&quot;charges&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">dipolemoment</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">][</span><span class="s2">&quot;dipoleMoment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">dipolegradients</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">][</span><span class="s2">&quot;dipoleGradients&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_restart_cache</span> <span class="ow">and</span> <span class="n">prev_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_results</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_cache</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;prevTitle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_results</span><span class="o">.</span><span class="n">name</span>

            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;geometryoptimization&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">coordinatetype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;coordinateType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">coordinatetype</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">usesymmetry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;useSymmetry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">usesymmetry</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">optimizelattice</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;optimizeLattice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">maxiterations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;maxIterations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxiterations</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pretendconverged</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;pretendConverged&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">calcpropertiesonlyifconverged</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;calcPropertiesIfNotConverged&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">convenergy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;convEnergy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">convenergy</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">convgradients</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;convGradients&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">convgradients</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">convstep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;convStep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">convstep</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">convstressenergyperatom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;convStressEnergyPerAtom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">convstressenergyperatom</span><span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="s2">&quot;Optimize&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="s2">&quot;Solve&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unflatten_arrays</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">])</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">AMSWorkerResults</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_restart_cache</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restart_cache</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete_from_restart_cache</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">results</span>

        <span class="k">except</span> <span class="n">AMSPipeRuntimeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AMSWorkerResults</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">AMSWorkerError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="c1"># Something went wrong. Our worker process might also be down.</span>
            <span class="c1"># Let&#39;s reset everything to be safe ...</span>
            <span class="n">exc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_subprocess</span><span class="p">()</span>
            <span class="c1"># ... and return an AMSWorkerResults object indicating our failure.</span>
            <span class="k">return</span> <span class="n">AMSWorkerResults</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>


<div class="viewcode-block" id="AMSWorker.SinglePoint"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorker.SinglePoint">[docs]</a>    <span class="k">def</span> <span class="nf">SinglePoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">prev_results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">gradients</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stresstensor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hessian</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">elastictensor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">charges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dipolemoment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dipolegradients</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs a single point calculation on the geometry given by the |Molecule| instance *molecule* and returns an instance of |AMSWorkerResults| containing the results.</span>

<span class="sd">        Every calculation should be given a *name*. Note that the name **must be unique** for this |AMSWorker| instance: One should not attempt to reuse calculation names with a given instance of |AMSWorker|.</span>

<span class="sd">        By default only the total energy is calculated but additional properties can be requested using the corresponding keyword arguments:</span>

<span class="sd">        - *gradients*: Calculate the nuclear gradients of the total energy.</span>
<span class="sd">        - *stresstensor*: Calculate the clamped-ion stress tensor. This should only be requested for periodic systems.</span>
<span class="sd">        - *hessian*: Calculate the Hessian matrix, i.e. the second derivative of the total energy with respect to the nuclear coordinates.</span>
<span class="sd">        - *elastictensor*: Calculate the elastic tensor. This should only be requested for periodic systems.</span>
<span class="sd">        - *charges*: Calculate atomic charges.</span>
<span class="sd">        - *dipolemoment*: Calculate the electric dipole moment. This should only be requested for non-periodic systems.</span>
<span class="sd">        - *dipolegradients*: Calculate the nuclear gradients of the electric dipole moment. This should only be requested for non-periodic systems.</span>

<span class="sd">        Users can pass an instance of a previously obtained |AMSWorkerResults| as the *prev_results* keyword argument. This can trigger a restart from previous results in the worker process, the details of which depend on the used computational engine: For example, a DFT based engine might restart from the electronic density obtained in an earlier calculation on a similar geometry. This is often useful to speed up series of sequentially dependent calculations:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            mol = Molecule(&#39;some/system.xyz&#39;)</span>
<span class="sd">            with AMSWorker(sett) as worker:</span>
<span class="sd">                last_results = None</span>
<span class="sd">                do i in range(num_steps):</span>
<span class="sd">                    results = worker.SinglePoint(f&#39;step{i}&#39;, mol, prev_results=last_results, gradients=True)</span>
<span class="sd">                    # modify the geometry of mol using results.get_gradients()</span>
<span class="sd">                    last_results = results</span>

<span class="sd">        Note that the restarting is disabled if the |AMSWorker| instance was created with ``use_restart_cache=False``. It is still permitted to pass previous |AMSResults| instances as the *prev_results* argument, but no restarting will happen.</span>

<span class="sd">        The *quiet* keyword can be used to obtain more output from the worker process. Note that the output of the worker process is not printed to the standard output but instead ends up in the ``ams.out`` file in the temporary working directory of the |AMSWorker| instance. This is mainly useful for debugging.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;molecule&#39;</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args_to_settings</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ams</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="s1">&#39;singlepoint&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solve_from_settings</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span></div>


<div class="viewcode-block" id="AMSWorker.GeometryOptimization"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorker.GeometryOptimization">[docs]</a>    <span class="k">def</span> <span class="nf">GeometryOptimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">prev_results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">gradients</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stresstensor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hessian</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">elastictensor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">charges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dipolemoment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dipolegradients</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coordinatetype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">usesymmetry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optimizelattice</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">maxiterations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pretendconverged</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">calcpropertiesonlyifconverged</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">convenergy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">convgradients</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">convstep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">convstressenergyperatom</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs a geometry optimization on the |Molecule| instance *molecule* and returns an instance of |AMSWorkerResults| containing the results from the optimized geometry.</span>

<span class="sd">        The geometry optimizer can be controlled using the following keyword arguments:</span>

<span class="sd">        - *method*: String identifier of a particular optimization algorithm.</span>
<span class="sd">        - *coordinatetype*: Select a particular kind of optimization coordinates.</span>
<span class="sd">        - *usesymmetry*: Enable the use of symmetry when applicable.</span>
<span class="sd">        - *optimizelattice*: Optimize the lattice vectors together with atomic positions.</span>
<span class="sd">        - *maxiterations*: Maximum number of iterations allowed.</span>
<span class="sd">        - *pretendconverged*: If set to true, non converged geometry optimizations will be considered successful.</span>
<span class="sd">        - *calcpropertiesonlyifconverged*: Calculate properties (e.g. the Hessian) only if the optimization converged.</span>
<span class="sd">        - *convenergy*: Convergence criterion for the energy (in Hartree).</span>
<span class="sd">        - *convgradients*: Convergence criterion for the gradients (in Hartree/Bohr).</span>
<span class="sd">        - *convstep*: Convergence criterion for displacements (in Bohr).</span>
<span class="sd">        - *convstressenergyperatom*: Convergence criterion for the stress energy per atom (in Hartree).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gradients</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">optimizelattice</span><span class="p">:</span>
            <span class="n">stresstensor</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;molecule&#39;</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args_to_settings</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ams</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="s1">&#39;geometryoptimization&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solve_from_settings</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span></div>


<div class="viewcode-block" id="AMSWorker.ParseInput"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorker.ParseInput">[docs]</a>    <span class="k">def</span> <span class="nf">ParseInput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program_name</span><span class="p">,</span> <span class="n">text_input</span><span class="p">,</span> <span class="n">string_leafs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the text input and return a Python dictionary representing the the JSONified input.</span>

<span class="sd">        - *program_name*: the name of the program. This will be used for loading the appropriate json input definitions. e.g. if program_name=&#39;adf&#39;, the input definition file &#39;adf.json&#39; will be used.</span>
<span class="sd">        - *text_input*: a string containing the text input to be parsed.</span>
<span class="sd">        - *string_leafs*: if *True* the values in the parsed json input will always be string. e.g. if in the input you have &#39;SomeFloat 1.2&#39;, the json leaf node for &#39;SomeFloat&#39; will be the string &#39;1.2&#39; (and not the float number 1.2). If False the leaf values in the json input will be of the &#39;appropriate&#39; type, i.e. float will be floats, strings will be strings, booleans will be boleans etc...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="s2">&quot;ParseInput&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;programName&quot;</span><span class="p">:</span> <span class="n">program_name</span><span class="p">,</span> <span class="s2">&quot;textInput&quot;</span><span class="p">:</span> <span class="n">text_input</span><span class="p">,</span> <span class="s2">&quot;stringLeafs&quot;</span><span class="p">:</span> <span class="n">string_leafs</span><span class="p">})</span>
            <span class="n">json_input</span> <span class="o">=</span> <span class="n">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;parsedInput&#39;</span><span class="p">][</span><span class="s1">&#39;jsonInput&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">json_input</span>
        <span class="k">except</span> <span class="n">AMSWorkerError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="c1"># This failed badly, also the worker is likely down. Let&#39;s grab some info, restart it ...</span>
            <span class="n">exc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_subprocess</span><span class="p">()</span>
            <span class="c1"># ... and then reraise the exception for the caller.</span>
            <span class="k">raise</span></div>


    <span class="k">def</span> <span class="nf">_check_process</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">status</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>


    <span class="k">def</span> <span class="nf">_flatten_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">out</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_dim_&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;int&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
                <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flatten_arrays</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">out</span>


    <span class="k">def</span> <span class="nf">_unflatten_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_dim_&quot;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_dim_&quot;</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_dim_&quot;</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
                <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unflatten_arrays</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_read_exactly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">buf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">EOFError</span><span class="p">(</span><span class="s2">&quot;Message truncated&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">ubjson</span><span class="o">.</span><span class="n">dumpb</span><span class="p">({</span><span class="n">method</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flatten_arrays</span><span class="p">(</span><span class="n">args</span><span class="p">)})</span>
        <span class="n">msglen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;=i&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callpipe</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msglen</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Set&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callpipe</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AMSWorkerError</span><span class="p">(</span><span class="s1">&#39;Error while sending a message&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;Exit&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msgbuf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_exactly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">replypipe</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">msglen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;=i&quot;</span><span class="p">,</span> <span class="n">msgbuf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">msgbuf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_exactly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">replypipe</span><span class="p">,</span> <span class="n">msglen</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">EOFError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AMSWorkerError</span><span class="p">(</span><span class="s2">&quot;Error while trying to read a reply&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">ubjson</span><span class="o">.</span><span class="n">loadb</span><span class="p">(</span><span class="n">msgbuf</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AMSWorkerError</span><span class="p">(</span><span class="s2">&quot;Error while decoding a reply&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

            <span class="k">if</span> <span class="s2">&quot;return&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;return&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">results</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">AMSPipeError</span><span class="o">.</span><span class="n">from_message</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="AMSWorkerPool"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerPool">[docs]</a><span class="k">class</span> <span class="nc">AMSWorkerPool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A class representing a pool of AMS worker processes.</span>

<span class="sd">    All workers of the pool are initialized with the same |Settings| instance, see the |AMSWorker| constructor for details.</span>

<span class="sd">    The number of spawned workers is determined by the *num_workers* argument. For optimal performance on many small jobs it is recommended to spawn a number of workers equal to the number of physical CPU cores of the machine the calculation is running on, and to let every worker instance run serially:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        import psutil</span>

<span class="sd">        molecules = read_molecules(&#39;folder/with/xyz/files&#39;)</span>

<span class="sd">        sett = Settings()</span>
<span class="sd">        # ... more settings ...</span>
<span class="sd">        sett.runscript.nproc = 1 # &lt;-- every worker itself is serial (aka export NSCM=1)</span>

<span class="sd">        with AMSWorkerPool(sett, psutil.cpu_count(logical=False)) as pool:</span>
<span class="sd">            results = pool.SinglePoints([ (name, molecules[name]) for name in sorted(molecules) ])</span>

<span class="sd">    As with the underlying |AMSWorker| class, the location of the temporary directories can be changed with the *workerdir_root* and *workerdir_prefix* arguments.</span>

<span class="sd">    It is recommended to use the |AMSWorkerPool| as a context manager in order to ensure that cleanup happens automatically. If it is not possible to use the |AMSWorkerPool| as a context manager, cleanup should be manually triggered by calling the :meth:`stop` method.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jobrunner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jobmanager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">workerdir_root</span><span class="o">=</span><span class="n">TMPDIR</span><span class="p">,</span> <span class="n">workerdir_prefix</span><span class="o">=</span><span class="s1">&#39;awp&#39;</span><span class="p">,</span>
                 <span class="n">keep_crashed_workerdir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reuse_system</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">jobmanager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;default_jobmanager&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                <span class="n">jobmanager</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">default_jobmanager</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The jobmanager is not currently used for anything anyway</span>
                <span class="n">jobmanager</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1">#raise PlamsError(&#39;No default jobmanager found. This probably means that PLAMS init() was not called.&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobmanager</span> <span class="o">=</span> <span class="n">jobmanager</span>

        <span class="c1"># Choose the number of workers based on jobrunner first, num_workers second</span>
        <span class="k">if</span> <span class="n">jobrunner</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">num_workers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="k">if</span> <span class="n">num_workers</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
                    <span class="n">jobrunner</span> <span class="o">=</span> <span class="n">JobRunner</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">maxjobs</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span> 
                <span class="k">else</span> <span class="p">:</span>  
                    <span class="n">jobrunner</span> <span class="o">=</span> <span class="n">JobRunner</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maxjobs</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;default_jobrunner&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                    <span class="n">jobrunnner</span> <span class="o">=</span> <span class="n">config</span><span class="p">,</span><span class="n">default_jobrunner</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="n">PlamsError</span><span class="p">(</span><span class="s1">&#39;No default jobrunner found. This probably means that PLAMS init() was not called.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobrunner</span> <span class="o">=</span> <span class="n">jobrunner</span>
        <span class="n">num_workers</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">jobrunner</span><span class="o">.</span><span class="n">parallel</span> <span class="p">:</span>
            <span class="n">num_workers</span> <span class="o">=</span> <span class="n">jobrunner</span><span class="o">.</span><span class="n">maxjobs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workers</span> <span class="o">=</span> <span class="n">num_workers</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">num_workers</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Do all the work in the main thread</span>
            <span class="n">AMSWorkerPool</span><span class="o">.</span><span class="n">_spawn_worker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">workerdir_root</span><span class="p">,</span> <span class="n">workerdir_prefix</span><span class="p">,</span> <span class="n">keep_crashed_workerdir</span><span class="p">,</span> <span class="n">reuse_system</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Spawn all workers from separate threads to overlap the ams.exe startup latency</span>
            <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">AMSWorkerPool</span><span class="o">.</span><span class="n">_spawn_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">workerdir_root</span><span class="p">,</span> <span class="n">workerdir_prefix</span><span class="p">,</span> <span class="n">keep_crashed_workerdir</span><span class="p">,</span> <span class="n">reuse_system</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_workers</span><span class="p">)</span> <span class="p">]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AMSWorkerError</span><span class="p">(</span><span class="s1">&#39;Some AMSWorkers in the pool failed to start&#39;</span><span class="p">)</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_spawn_worker</span><span class="p">(</span><span class="n">workers</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">wdr</span><span class="p">,</span> <span class="n">wdp</span><span class="p">,</span> <span class="n">keep_crashed_workerdir</span><span class="p">,</span> <span class="n">reuse_system</span><span class="p">):</span>
        <span class="n">use_restart_cache</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">reuse_system</span> <span class="p">:</span>
                <span class="n">use_restart_cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">workers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">AMSWorker</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">workerdir_root</span><span class="o">=</span><span class="n">wdr</span><span class="p">,</span> <span class="n">workerdir_prefix</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{wdp}</span><span class="s1">_</span><span class="si">{i}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">use_restart_cache</span><span class="o">=</span><span class="n">use_restart_cache</span><span class="p">,</span> <span class="n">keep_crashed_workerdir</span><span class="o">=</span><span class="n">keep_crashed_workerdir</span><span class="p">,</span> <span class="n">reuse_system</span><span class="o">=</span><span class="n">reuse_system</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>


    <span class="k">def</span> <span class="nf">_solve_from_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Request to pool to execute calculations for all items in the iterable *items*. Returns a list of |AMSWorkerResults| objects.</span>

<span class="sd">        The *items* argument is expected to be an iterable of 3-tuples ``(name, molecule, settings)``, which are passed on to the the :meth:`_solve_from_settings &lt;AMSWorker._solve_from_settings&gt;` method of the pool&#39;s |AMSWorker| instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobrunner</span><span class="o">.</span><span class="n">parallel</span> <span class="p">:</span>

            <span class="c1"># Do all the work in the main thread (REB: should be removed. Jobrunner should handle this as well)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_solve_from_settings</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">settings</span> <span class="ow">in</span> <span class="n">items</span> <span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Build a queue of things to do and spawn threads that grab from from the queue in parallel</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
            <span class="n">events</span> <span class="o">=</span> <span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">]</span>

            <span class="c1"># Call jobrunner._run_job several times. That will start the threads</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">worker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">)</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jobrunner</span><span class="o">.</span><span class="n">_run_job_with_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobmanager</span><span class="p">,</span> <span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">results</span><span class="p">),(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">],))</span>
            <span class="c1">#threads = [ threading.Thread(target=AMSWorkerPool._execute_queue, args=(self.workers[i], q, results)) for i in range(len(self.workers)) ]</span>
            <span class="c1">#for t in threads: t.start()</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">item</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;AMSWorkerPool._solve_from_settings expects a list containing only 3-tuples (name, molecule, settings).&#39;</span><span class="p">)</span>
                <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">settings</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">))</span> <span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># signal for the thread to end</span>

            <span class="c1"># Wait till the processes are finished</span>
            <span class="c1"># Later I want to move this to the results object</span>
            <span class="c1"># Then I have to make sure that the __exit__ method also waits for the worker to be done</span>
            <span class="k">for</span> <span class="n">done</span> <span class="ow">in</span> <span class="n">events</span> <span class="p">:</span>
                <span class="n">done</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="c1">#print (&#39;All workers are done&#39;)</span>

        <span class="k">return</span> <span class="n">results</span>


    <span class="k">def</span> <span class="nf">_prep_solve_from_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>

        <span class="n">solve_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">mol</span> <span class="o">=</span> <span class="n">item</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;AMSWorkerPool.</span><span class="si">{method}</span><span class="s1">s expects a list containing only 2-tuples (name, molecule) and/or 3-tuples (name, molecule, kwargs).&#39;</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">AMSWorker</span><span class="o">.</span><span class="n">_args_to_settings</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ams</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="n">solve_items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">solve_items</span>


<div class="viewcode-block" id="AMSWorkerPool.SinglePoints"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerPool.SinglePoints">[docs]</a>    <span class="k">def</span> <span class="nf">SinglePoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Request to pool to execute single point calculations for all items in the iterable *items*. Returns a list of |AMSWorkerResults| objects.</span>

<span class="sd">        The *items* argument is expected to be an iterable of 2-tuples ``(name, molecule)`` and/or 3-tuples ``(name, molecule, kwargs)``, which are passed on to the :meth:`SinglePoint &lt;AMSWorker.SinglePoint&gt;` method of the pool&#39;s |AMSWorker| instances. (Here ``kwargs`` is a dictionary containing the optional keyword arguments and their values for this method.)</span>

<span class="sd">        As an example, the following call would do single point calculations with gradients and (only for periodic systems) stress tensors for all |Molecule| instances in the dictionary ``molecules``.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            results = pool.SinglePoint([ (name, molecules[name], {</span>
<span class="sd">                                             &quot;gradients&quot;: True,</span>
<span class="sd">                                             &quot;stresstensor&quot;: len(molecules[name].lattice) != 0</span>
<span class="sd">                                          }) for name in sorted(molecules) ])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">solve_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_solve_from_settings</span><span class="p">(</span><span class="s1">&#39;SinglePoint&#39;</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solve_from_settings</span><span class="p">(</span><span class="n">solve_items</span><span class="p">)</span></div>



<div class="viewcode-block" id="AMSWorkerPool.GeometryOptimizations"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerPool.GeometryOptimizations">[docs]</a>    <span class="k">def</span> <span class="nf">GeometryOptimizations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Request to pool to execute geometry optimizations for all items in the iterable *items*. Returns a list of |AMSWorkerResults| objects for the optimized geometries.</span>

<span class="sd">        The *items* argument is expected to be an iterable of 2-tuples ``(name, molecule)`` and/or 3-tuples ``(name, molecule, kwargs)``, which are passed on to the :meth:`GeometryOptimization &lt;AMSWorker.GeometryOptimization&gt;` method of the pool&#39;s |AMSWorker| instances. (Here ``kwargs`` is a dictionary containing the optional keyword arguments and their values for this method.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">solve_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_solve_from_settings</span><span class="p">(</span><span class="s1">&#39;GeometryOptimization&#39;</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solve_from_settings</span><span class="p">(</span><span class="n">solve_items</span><span class="p">)</span></div>


<div class="viewcode-block" id="AMSWorkerPool.stop"><a class="viewcode-back" href="../../../../../interfaces/amsworker.html#scm.plams.interfaces.adfsuite.amsworker.AMSWorkerPool.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stops the all worker processes and removes their working directories.</span>

<span class="sd">        This method should be called when the |AMSWorkerPool| instance is not used as a context manager and the instance is no longer needed. Otherwise proper cleanup is not guaranteed to happen, worker processes might be left running and files might be left on disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_execute_queue</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function will handle all tasks in the queue, before finishing.</span>

<span class="sd">        Note: To be wrapped by the jobrunner</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">prev_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">item</span>
                <span class="c1"># Reuse the previous results, to minimize the work</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">_args_to_settings</span><span class="p">(</span><span class="n">prev_results</span><span class="o">=</span><span class="n">prev_results</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
                    <span class="n">settings</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">_solve_from_settings</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
                <span class="n">prev_results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span> <span class="p">:</span>
                <span class="k">return</span> <span class="n">exc</span>


    <span class="k">def</span> <span class="nf">_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobmanager</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare for a task for this worker</span>

<span class="sd">        Called by jobrunner._run_job()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># For now I am bypassing the jobmanager completely</span>
        <span class="k">return</span> <span class="kc">True</span>


    <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobrunner</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To be called by jobrunner._run_job. Does nothing else than call the relevant jobrunner call() method</span>
<span class="sd">        (from within a thread created by the jobrunner).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">jobrunner</span><span class="o">.</span><span class="n">call_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_execute_queue</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">results</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the event (self.done) that signals the job is over.</span>

<span class="sd">        Called by jobrunner._run_job()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">done</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">exc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span></div>

</pre></div>

           </div>
          </div>
          <!--STARTNOSOLR-->
<footer>
  

  <hr/> 

<!-- start :: footer -->
		<footer class="site-footer block">
			<div class="container">
				<div class="row">
					<div class="footer-column" >
	<ul>
		<li id="nav_menu-2" class="widget widget_nav_menu "><h3>Application Areas</h3><div class="menu-application-areas-container"><ul id="menu-application-areas" class="menu">
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/batteries/">Batteries &#038; PVs</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/chemical-bonding-analysis/">Bonding Analysis</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/catalysis/">Catalysis</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/heavy-elements/">Heavy Elements</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/inorganic-chemistry/">Inorganic Chemistry</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/pharma/">Life Sciences</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/materials-science/">Materials Science</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/nanotechnology/">Nanotechnology</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/oil-and-gas/">Oil and Gas</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/organic-electronics/">Organic Electronics</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/polymers/">Polymers</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/spectroscopy/">Spectroscopy</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/teaching/">Teaching</a></li>
</ul></div></li>	</ul>
</div><div class="footer-column" >
	<ul>
		<li id="nav_menu-7" class="widget widget_nav_menu "><h3>Products</h3><div class="menu-product-navigation-container"><ul id="menu-product-navigation" class="menu">
<li id="menu-item-40263" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-40263"><a href="https://www.scm.com/product/ams/">AMS Driver</a></li>
<li id="menu-item-7235" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-7235"><a href="https://www.scm.com/product/adf/">ADF</a></li>
<li id="menu-item-7236" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-7236"><a href="https://www.scm.com/product/band_periodicdft/">BAND</a></li>
<li id="menu-item-7237" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-7237"><a href="https://www.scm.com/product/cosmo-rs/">COSMO-RS</a></li>
<li id="menu-item-7238" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-7238"><a href="https://www.scm.com/product/dftb/">DFTB</a></li>
<li id="menu-item-7239" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-7239"><a href="https://www.scm.com/product/gui/">GUI</a></li>
<li id="menu-item-44383" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-44383"><a href="https://www.scm.com/product/machine-learning-potentials/">MLPotential</a></li>
<li id="menu-item-7240" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-7240"><a href="https://www.scm.com/product/mopac/">MOPAC</a></li>
<li id="menu-item-40262" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-40262"><a href="https://www.scm.com/product/plams/">PLAMS</a></li>
<li id="menu-item-43701" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-43701"><a href="https://www.scm.com/product/quantum-espresso/">Quantum ESPRESSO</a></li>
<li id="menu-item-7241" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-7241"><a href="https://www.scm.com/product/reaxff/">ReaxFF</a></li></ul></div></li><li id="nav_menu-26" class="widget widget_nav_menu "><div class="menu-licensing-container"><ul id="menu-licensing" class="menu"><li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/pricing-licensing/">Pricing &#038; Licensing</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/pricing-licensing/price-quote/">Price Quote</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/pricing-licensing/price-quote/calculate-your-price/">Price Calculator</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/consulting/">Scientific Consulting</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/pricing-licensing/adf-resellers/">Resellers</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/pricing-licensing/scm-license-terms/">License Terms</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/pricing-licensing/ordering-procedure/">Ordering</a></li>
</ul></div></li>	</ul>
</div><div class="footer-column" >
	<ul>
		<li id="nav_menu-6" class="widget widget_nav_menu "><h3>Support</h3><div class="menu-support-navigation-container"><ul id="menu-support-navigation" class="menu"><li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/support/">Support Overview</a></li>
<li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.scm.com/support/ams-installation-videos/">Installation</a></li>
<li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.scm.com/support/ams-tutorials-and-manuals/">Documentation</a></li>
<li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.scm.com/doc/Tutorials/GUI_overview/GUI_overview_tutorials.html">GUI Tutorials</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/support/downloads/">Downloads</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/faq/">FAQs</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/adf-discussion-list/">Discussion List</a></li>
<li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.scm.com/support/documentation-previous-versions/release-notes/">Release Notes</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/support/adf-teaching-materials/">Teaching Materials</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/news-agenda/adf-hands-on-workshops/">Workshops</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/news-agenda/web-presentations-by-adf-experts/">Webinars</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/videos-tutorials-and-web-presentations/">Videos</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/brochures/">Brochure</a></li>
<li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.scm.com/amsterdam-modeling-suite/research-papers-citing-adf/">Papers Citing ADF</a></li>
<li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.scm.com/category/highlights/">Literature Highlights</a></li>
</ul></div></li>	</ul>
</div><div class="footer-column" >
	<ul>
		<li id="nav_menu-28" class="widget widget_nav_menu "><h3>About Us</h3><div class="menu-about-us-container"><ul id="menu-about-us" class="menu"><li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/contact-us/">Contact Us</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/eu-projects/">EU Projects</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/our-authors/">Contributors</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/our-people/">The SCM Team</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/collaborations/">Collaborations</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/careers/">Careers</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/mission-vision/">Mission &#038; Vision</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/newsletters/">Newsletters</a></li>
<li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.scm.com/category/news/">News</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/news-agenda/">Events</a></li>
</ul></div></li>	</ul>
</div><div class="footer-column" >
	<ul>
			</ul>
</div>				</div>
			</div>
		</footer>
		<footer class="disclaimer-footer">
			<img src="https://www.scm.com/wp-content/themes/scm/images/logos/scm-logo-compact.svg" alt="">
			<nav class="menu-service-navigation-container"><ul id="menu-service-navigation" class="menu-service navbar-nav"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-73"><a href="https://www.scm.com/copyright/">Copyright</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-72"><a href="https://www.scm.com/terms-of-use/">Terms of Use</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-privacy-policy menu-item-71"><a href="https://www.scm.com/privacy-policy/">Privacy Policy</a></li>
</ul></nav></footer>	
		<!-- end :: footer -->

<!--ENDNOSOLR-->
        </div>
      </div>

    </section>
  </div>
  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../../',
            VERSION:'2021.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCRWHZZ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
      <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../../../_static/language_data.js"></script>
      <script type="text/javascript" src="../../../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.js"></script>
      <script type="text/javascript" src="../../../../../_static/sphinx_tabs/tabs.js"></script>
      <script type="text/javascript" src="../../../../../_static/../../MathJax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>