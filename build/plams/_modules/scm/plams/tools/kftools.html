

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
<META name="ROBOTS" content="NOINDEX, NOFOLLOW">
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>scm.plams.tools.kftools &mdash; PLAMS 2021.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../../_static/css/theme_tabs.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../../_static/panels-bootstrap.min.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../search.html"/>
    <link rel="top" title="PLAMS 2021.1 documentation" href="../../../../index.html"/>
        <link rel="up" title="Module code" href="../../../index.html"/> 

  
  <script src="../../../../_static/js/jquery.min.js"></script>
  <script src="../../../../_static/js/bootstrap.min.js"></script>
  <script src="../../../../_static/js/modernizr.min.js"></script>
  <script src="../../../../_static/js/app.js"></script>
<script type="text/javascript">
</script>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NCRWHZZ');</script>
<!-- End Google Tag Manager -->

</head>

<body class="wy-body-for-nav" role="document">
  <!--STARTNOSOLR-->
  <header class="site-header navbar-fixed-top compact">
      <nav class="main navbar navbar-default">
        <div class="headerbar_container">
          <a role="button" href="/free-trial/" class="btn btn-sm btn-primary">Free trial</a>
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <div class="navbar-brand">
              <a class="logo" href="https://www.scm.com">
                <img class="logo-small" src="https://www.scm.com/wp-content/themes/scm/images/logos/scm-logo-compact.svg" alt="Software for Chemistry &amp; Materials" />
                <img class="logo-full" src="https://www.scm.com/wp-content/themes/scm/images/logos/scm-logo.svg" alt="Software for Chemistry &amp; Materials" />
              </a>
            </div>
          </div>
          <div class="nav-wrapper">
            <div class="collapse navbar-collapse">
              <ul id="menu-primary-navigation" class="nav navbar-nav"><li id="menu-item-40077" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-40077"><a title="Applications" href="https://www.scm.com/applications/">Applications</a></li>
<li id="menu-item-35" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-35"><a title="Products" href="https://www.scm.com/amsterdam-modeling-suite/">Products</a></li>
<li id="menu-item-36" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-36"><a title="Support" href="https://www.scm.com/support/">Support</a></li>
<li id="menu-item-37" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-37"><a title="About us" href="https://www.scm.com/about-us/">About us</a></li>
</ul>                           <span class="search"><a class="menu_search_link" href="https://www.scm.com/search.php"></a><span class="sr-only">Search</span></span>
            </div>
          </div>
        </div>
      </nav>
 </header>
    

   
  <div id="doc-wrapper">
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html">
          

          
            
            <img src="../../../../_static/plams_logo.png" class="logo" />
          
          </a>

          
          
  <ul>
      <li class="wy-breadcrumbs-aside">
        
           
           
        
      </li>
  </ul>
 
<!--ENDNOSOLR-->
             <!--STARTNOSOLR-->
<div role="search">
  <form id="rtd-search-form" class="wy-form search-docs-form" action="https://www.scm.com/search.php" method="get">
  <div class="input-group">
    <input type="text" name="search" placeholder="Search PLAMS" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
    <input type="hidden" name="root" value="doctrunk" />


    <input type="hidden" name="cat" value="doc-scripting" />


    <span class="input-group-btn">
			<button type="submit" class="btn btn-primary"><span class="sr-only">Search</span><span class="fa fa-search"></span></button>
		</span>
	</div>
  </form>
</div>
<!--ENDNOSOLR-->
          

          
        </div>
<!--STARTNOSOLR-->
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Table of contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../intro.html#what-is-plams">What is PLAMS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../intro.html#what-can-be-done-with-plams">What can be done with PLAMS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../intro.html#simple-example">Simple example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../intro.html#what-plams-is-not">What PLAMS is <em>not</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../intro.html#about-this-documentation">About this documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../started.html">Getting started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../started.html#library-contents">Library contents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../started.html#installing-plams">Installing PLAMS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../started.html#updating-plams">Updating PLAMS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../started.html#running-plams">Running PLAMS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../started.html#defaults-file">Defaults file</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../started.html#the-launch-script">The launch script</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../started.html#working-folder-location">Working folder location</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../started.html#passing-variables">Passing variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../started.html#importing-past-jobs">Importing past jobs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../started.html#restarting-failed-script">Restarting failed script</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../started.html#multiple-input-scripts">Multiple input scripts</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../components/components.html">Components overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../components/settings.html">Settings</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/settings.html#tree-like-structure">Tree-like structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/settings.html#dot-notation">Dot notation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/settings.html#case-sensitivity">Case sensitivity</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/settings.html#global-settings">Global settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/settings.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../components/jobs.html">Jobs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/jobs.html#preparing-a-job">Preparing a job</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../components/jobs.html#contents-of-job-settings">Contents of job settings</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../components/jobs.html#default-settings">Default settings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/jobs.html#running-a-job">Running a job</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../components/jobs.html#name-conflicts">Name conflicts</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../components/jobs.html#prerun-and-postrun-methods">Prerun and postrun methods</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../components/jobs.html#preview-mode">Preview mode</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/jobs.html#job-api">Job API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/jobs.html#single-jobs">Single jobs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../components/jobs.html#subclassing-singlejob">Subclassing SingleJob</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/jobs.html#multijobs">Multijobs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../components/jobs.html#using-multijob">Using MultiJob</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../components/results.html">Results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/results.html#files-in-the-job-folder">Files in the job folder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/results.html#synchronization-of-parallel-job-executions">Synchronization of parallel job executions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../components/results.html#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/results.html#cleaning-job-folder">Cleaning job folder</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../components/results.html#cleaning-for-multijobs">Cleaning for multijobs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/results.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../components/runners.html">Job runners</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/runners.html#local-job-runner">Local job runner</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/runners.html#remote-job-runner">Remote job runner</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../components/jobmanager.html">Job manager</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/jobmanager.html#rerun-prevention">Rerun prevention</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/jobmanager.html#pickling">Pickling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/jobmanager.html#restarting-scripts">Restarting scripts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/jobmanager.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../components/functions.html">Public functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/functions.html#logging">Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/functions.html#binding-decorators">Binding decorators</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../components/molecule.html">Molecule</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/mol_api.html">Molecule</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../components/mol_api.html#atom-labeling">Atom labeling</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/atombond.html">Atom</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/atombond.html#bond">Bond</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/mol_rdkit.html">RDKit interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/mol_ase.html">ASE interface</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../components/utils.html">Utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/utils.html#periodic-table">Periodic Table</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/utils.html#units">Units</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/utils.html#geometry-tools">Geometry tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/utils.html#file-format-conversion-tools">File format conversion tools</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../components/trajectories.html">Trajectories</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/xyz.html">XYZ trajectory files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../components/xyz.html#xyz-history-files">XYZ history files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/rkf.html">RKF trajectory files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../components/rkf.html#rkf-history-files">RKF history files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../components/dcd.html">DCD trajectory files</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../interfaces/interfaces.html">Interfaces</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../interfaces/amssuite.html">Amsterdam Modeling Suite</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../interfaces/ams.html">AMS driver and engines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/ams.html#preparing-input">Preparing input</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/ams.html#preparing-runscript">Preparing runscript</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/ams.html#molecule-handling">Molecule handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/ams.html#amsjob-api">AMSJob API</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/ams.html#amsresults-api">AMSResults API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../interfaces/amsworker.html">AMS worker</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/amsworker.html#amsworker-api">AMSWorker API</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/amsworker.html#amsworkerresults-api">AMSWorkerResults API</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/amsworker.html#amsworkerpool-api">AMSWorkerPool API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../interfaces/postadf.html">Analysis tools: Densf, FCF, analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../interfaces/kffiles.html">KF files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../interfaces/crs.html">COSMO-RS</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/crs.html#settings">Settings</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/crs.html#settings-with-multiple-compound">Settings with multiple compound</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/crs.html#adf-and-crsjob">ADF and CRSJob</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/crs.html#cosmo-rs-parameters">COSMO-RS Parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/crs.html#data-analyses-and-plotting">Data analyses and plotting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/crs.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../interfaces/adf.html">ADF (pre-2020 version)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/adf.html#preparing-input">Preparing input</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/adf.html#preparing-runscript">Preparing runscript</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/adf.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../interfaces/reaxff.html">ReaxFF (pre-2019 version)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../interfaces/thirdparty.html">Other programs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../interfaces/cp2k.html">CP2K</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/cp2k.html#settings">Settings</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/cp2k.html#molecule-parsing">Molecule parsing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/cp2k.html#loading-jobs">Loading jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/cp2k.html#molecule-loading">Molecule loading</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/cp2k.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../interfaces/crystal.html">Crystal</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/crystal.html#preparing-a-calculation">Preparing a calculation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/crystal.html#molecule-parsing">Molecule parsing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/crystal.html#results-extraction">Results extraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/crystal.html#example">Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/crystal.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../interfaces/dftbplus.html">DFTB+</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/dftbplus.html#preparing-a-calculation">Preparing a calculation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/dftbplus.html#results-extraction">Results extraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/dftbplus.html#example">Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/dftbplus.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../interfaces/dirac.html">Dirac</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/dirac.html#preparing-a-calculation">Preparing a calculation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/dirac.html#results-extraction">Results extraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/dirac.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../interfaces/mopac.html">MOPAC (standalone program)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/mopac.html#preparing-input">Preparing input</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/mopac.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../interfaces/orca.html">ORCA</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/orca.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../interfaces/raspa.html">RASPA</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/raspa.html#input">Input</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/raspa.html#molecule-parsing">Molecule parsing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/raspa.html#loading-jobs">Loading jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../interfaces/raspa.html#api">API</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/examples.html">Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/examples.html#id1">Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/He2DissociationCurve.html">Helium dimer dissociation curve</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/WaterOptimization.html">Geometry optimization of water</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/ManyJobsInParallel.html">Many jobs in parallel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/BasisSetBenchmark.html">Benchmark accuracy of basis sets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/ExcitationsWorkflow.html">Workflow: filtering molecules based on excitation energies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/ChargeTransferIntegralsADF.html">Charge transfer integrals with ADF</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/gammascan.html">Tuning the range separation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/examples.html#pre-made-recipes">Pre-made recipes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/ams_crs.html">ADF and COSMO-RS workflow</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/adffragment.html">ADF fragment job</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/ReorganizationEnergy.html">Reorganization Energy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/adfnbo.html">NBO with ADF</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/numgrad.html">Numerical gradients</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/numhess.html">Numerical Hessian</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/molecule_gun.html">ReaxFF molecule gun</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/global_minimum.html">Global Minimum Search</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/vibrationASE.html">Vibrational analysis with ASE</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../examples/vibrationASE.html#example">Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../examples/vibrationASE.html#api">API</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cookbook/cookbook.html">Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../cookbook/cookbook.html#settings-and-input">Settings and input</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../cookbook/cookbook.html#create-an-input-block-with-an-header">Create an input block with an header</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../cookbook/cookbook.html#create-an-empty-input-block">Create an empty input block</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../cookbook/cookbook.html#convert-an-ams-text-input-into-an-ams-job">Convert an AMS text input into an AMS job</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../cookbook/cookbook.html#convert-an-ams-text-input-into-settings-object">Convert an AMS text input into settings object</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../cookbook/cookbook.html#convert-an-ams-run-file-into-an-amsjob">Convert an AMS .run file into an AMSJob</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../cookbook/cookbook.html#specify-paths-to-files-in-the-input">Specify paths to files in the input</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../cookbook/cookbook.html#restart-from-a-previous-job">Restart from a previous job</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../cookbook/cookbook.html#molecules">Molecules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../cookbook/cookbook.html#generate-a-molecule-from-a-smiles-string">Generate a molecule from a SMILES string</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../cookbook/cookbook.html#counting-rings">Counting rings</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../cookbook/cookbook.html#extracting-results">Extracting Results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../cookbook/cookbook.html#directly-from-functions">Directly from Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../cookbook/cookbook.html#examples-total-energy-and-final-structure">Examples: Total Energy and Final Structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../cookbook/cookbook.html#amsresults-api-functions">AMSResults API Functions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../cookbook/cookbook.html#from-the-rkf-interface">From the RKF Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../cookbook/cookbook.html#finding-section-variable-pairs">Finding Section/Variable Pairs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../cookbook/cookbook.html#from-python-directories">From Python Directories</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../cookbook/cookbook.html#kfbrowser">KFBrowser</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../cookbook/cookbook.html#from-molecular-dynamics-trajectories">From molecular dynamics trajectories</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../cookbook/cookbook.html#general-md-properties">General MD properties</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../cookbook/cookbook.html#molecules-from-trajectories">Molecules from trajectories</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../cookbook/cookbook.html#accessing-old-jobs">Accessing Old Jobs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../cookbook/cookbook.html#binding-native-plams-jobs">Binding Native PLAMS Jobs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../cookbook/cookbook.html#binding-old-rkf-files">Binding old RKF Files</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../citations.html">Citations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../index.html">PLAMS</a>
      </nav>
<!--ENDNOSOLR-->

      
      <div class="wy-nav-content">
        <div class="rst-content">
        <!--STARTNOSOLR-->
<div class="header" role="navigation" aria-label="breadcrumbs navigation">
 
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../PLAMS.html/../../Documentation/index.html">Documentation</a>/</li>
    <li><a href="../../../../index.html">PLAMS</a>/</li>
      
          <li><a href="../../../index.html">Module code</a>/</li>
      
    <li class="orange-text">scm.plams.tools.kftools</li>
  </ul>
  <p>
 
</div>
<!--ENDNOSOLR-->
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for scm.plams.tools.kftools</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="kn">from</span> <span class="nn">bisect</span> <span class="k">import</span> <span class="n">bisect</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="k">import</span> <span class="n">DEVNULL</span>

<span class="kn">from</span> <span class="nn">..core.private</span> <span class="k">import</span> <span class="n">saferun</span>
<span class="kn">from</span> <span class="nn">..core.errors</span> <span class="k">import</span> <span class="n">FileError</span>
<span class="kn">from</span> <span class="nn">..core.functions</span> <span class="k">import</span> <span class="n">log</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;KFFile&#39;</span><span class="p">,</span> <span class="s1">&#39;KFReader&#39;</span><span class="p">,</span> <span class="s1">&#39;KFHistory&#39;</span><span class="p">]</span>



<div class="viewcode-block" id="KFReader"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFReader">[docs]</a><span class="k">class</span> <span class="nc">KFReader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A class for efficient Python-native reader of binary files in KF format.</span>

<span class="sd">    This class offers read-only access to any fragment of data from a KF file. Unlike other Python KF readers, this one does not use the Fortran binary ``dmpkf`` to process KF files, but instead reads and interprets raw binary data straight from the file, on Python level. That approach results in significant speedup (by a factor of few hundreds for large files extracted variable by variable).</span>

<span class="sd">    The constructor argument *path* should be a string with a path (relative or absolute) to an existing KF file.</span>

<span class="sd">    *blocksize* indicates the length of basic KF file block. So far, all KF files produced by any of Amsterdam Modeling Suite programs have the same block size of 4096 bytes. Unless you&#39;re doing something *very* special, you should not touch this value.</span>

<span class="sd">    Organization of data inside KF file can depend on a machine on which this file was produced. Two parameters can vary: the length of integer (32 or 64 bit) and endian (little or big). These parameters have to be determined before any reading can take place, otherwise the results will have no sense. If the constructor argument *autodetect* is ``True``, the constructor attempts to automatically detect the format of a given KF file, allowing to read files created on a machine with different endian or integer length. This automatic detection is enabled by default and it is advised to leave it that way. If you wish to disable it, you should set ``endian`` and ``word`` attributes manually before reading anything (see the code for details).</span>

<span class="sd">    .. note ::</span>

<span class="sd">        This class consists of quite technical, low level code. If you don&#39;t need to modify or extend |KFReader|, you can safely ignore all private methods, all you need is :meth:`~KFReader.read` and occasionally :meth:`~KFReader.__iter__`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_sizes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;s&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;q&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">}</span>

<div class="viewcode-block" id="KFReader.__init__"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFReader.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span> <span class="n">autodetect</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FileError</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">{}</span><span class="s1"> not present&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_blocksize</span> <span class="o">=</span> <span class="n">blocksize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endian</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span>   <span class="c1"># endian: &#39;&lt;&#39; = little, &#39;&gt;&#39; = big</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word</span> <span class="o">=</span> <span class="s1">&#39;i&#39;</span>     <span class="c1"># length of int: &#39;i&#39; = 4 bits, &#39;q&#39; = 8 bits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sections</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">autodetect</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_autodetect</span><span class="p">()</span></div>


<div class="viewcode-block" id="KFReader.read"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFReader.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">variable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract and return data for a *variable* located in a *section*.</span>

<span class="sd">        For single-value numerical or boolean variables returned value is a single number or bool. For longer variables this method returns a list of values. For string variables a single string is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_index</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sections</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Section </span><span class="si">{}</span><span class="s1"> not present in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vtype</span><span class="p">,</span> <span class="n">vlb</span><span class="p">,</span> <span class="n">vstart</span><span class="p">,</span> <span class="n">vlen</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Variable </span><span class="si">{}</span><span class="s1"> not present in section </span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">KFReader</span><span class="o">.</span><span class="n">_datablocks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">section</span><span class="p">],</span> <span class="n">vlb</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_block</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">vtype</span><span class="p">)[</span><span class="n">vstart</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_block</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">vtype</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">vlen</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[:</span><span class="n">vlen</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;Latin-1&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="KFReader.variable_type"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFReader.variable_type">[docs]</a>    <span class="k">def</span> <span class="nf">variable_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">variable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the integer code of the variable&#39;s type (int:1, float:2, string:3, bool:4)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vtype</span><span class="p">,</span> <span class="n">vlb</span><span class="p">,</span> <span class="n">vstart</span><span class="p">,</span> <span class="n">vlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sections</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">variable</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Section &#39;</span><span class="si">{section}</span><span class="s2">&#39; or variable &#39;</span><span class="si">{variable}</span><span class="s2">&#39; not present in &#39;</span><span class="si">{self.path}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vtype</span></div>


<div class="viewcode-block" id="KFReader.__iter__"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFReader.__iter__">[docs]</a>    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iteration yields pairs of section name and variable name.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_index</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sections</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sections</span><span class="p">[</span><span class="n">section</span><span class="p">]:</span>
                <span class="k">yield</span> <span class="n">section</span><span class="p">,</span> <span class="n">variable</span></div>


<div class="viewcode-block" id="KFReader._autodetect"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFReader._autodetect">[docs]</a>    <span class="k">def</span> <span class="nf">_autodetect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to automatically detect the format (int size and endian) of this KF file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>

        <span class="n">blocksize</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="n">b</span><span class="p">[</span><span class="mi">28</span><span class="p">:</span><span class="mi">32</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocksize</span> <span class="o">=</span> <span class="mi">4096</span> <span class="k">if</span> <span class="n">blocksize</span> <span class="o">==</span> <span class="mi">538976288</span> <span class="k">else</span> <span class="n">blocksize</span>
        <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Block size of </span><span class="si">{}</span><span class="s1"> detected as </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocksize</span><span class="p">),</span> <span class="mi">7</span><span class="p">)</span>

        <span class="n">one</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">80</span><span class="p">:</span><span class="mi">84</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;32s&#39;</span><span class="p">,</span><span class="n">b</span><span class="p">[</span><span class="mi">48</span><span class="p">:</span><span class="mi">80</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;SUPERINDEX                      &#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">word</span> <span class="o">=</span> <span class="s1">&#39;i&#39;</span>
        <span class="k">elif</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;32s&#39;</span><span class="p">,</span><span class="n">b</span><span class="p">[</span><span class="mi">64</span><span class="p">:</span><span class="mi">96</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;SUPERINDEX                      &#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">word</span> <span class="o">=</span> <span class="s1">&#39;q&#39;</span>
            <span class="n">one</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">96</span><span class="p">:</span><span class="mi">104</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s1">&#39;WARNING: Unable to autodetect integer size and endian of </span><span class="si">{}</span><span class="s1">. Using defaults (4 bytes and little endian)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">word</span><span class="p">),</span> <span class="n">one</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">endian</span> <span class="o">=</span> <span class="n">e</span>
                <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;q&#39;</span><span class="p">:</span><span class="s1">&#39;8 bytes&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">:</span><span class="s1">&#39;4 bytes&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;&#39;</span><span class="p">:</span><span class="s1">&#39;little endian&#39;</span><span class="p">,</span><span class="s1">&#39;&gt;&#39;</span><span class="p">:</span><span class="s1">&#39;big endian&#39;</span><span class="p">,}</span>
                <span class="n">log</span><span class="p">((</span><span class="s1">&#39;Format of </span><span class="si">{0}</span><span class="s1"> detected to {&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">word</span><span class="o">+</span><span class="s1">&#39;} and {&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">endian</span><span class="o">+</span><span class="s1">&#39;}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">d</span><span class="p">),</span> <span class="mi">7</span><span class="p">)</span></div>


<div class="viewcode-block" id="KFReader._read_block"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFReader._read_block">[docs]</a>    <span class="k">def</span> <span class="nf">_read_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read a single block of binary data from posistion *pos* in file *f*.&quot;&quot;&quot;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">((</span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocksize</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocksize</span><span class="p">)</span></div>


<div class="viewcode-block" id="KFReader._parse"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFReader._parse">[docs]</a>    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="nb">format</span><span class="p">):</span>   <span class="c1">#format = [(32,&#39;s&#39;),(4,&#39;i&#39;),(2,&#39;d&#39;)]</span>
        <span class="sd">&quot;&quot;&quot;Translate a *block* of binary data into list of values in specified *format*.</span>

<span class="sd">        *format* should be a list of pairs *(a,t)* where *t* is one of the following characters: ``&#39;s&#39;`` for string (bytes), ``&#39;i&#39;`` for 32-bit integer, ``&#39;q&#39;`` for 64-bit integer and *a* is the number of occurrences (or length of a string).</span>

<span class="sd">        For example, if *format* is equal to ``[(32,&#39;s&#39;),(4,&#39;i&#39;),(2,&#39;d&#39;),(2,&#39;i&#39;)]``, the contents of *block* are divided into 72 bytes (32*1 + 4*4 + 2*8 + 2*4 = 72) chunks (possibly droping the last one, if it&#39;s shorter than 72 bytes). Then each chunk is translated to a 9-tuple of bytes, 4 ints, 2 floats and 2 ints. List of such tuples is the returned value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">formatstring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endian</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">format</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">+=</span> <span class="n">a</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sizes</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">formatstring</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span>

        <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">//</span> <span class="n">step</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">iter_unpack</span><span class="p">(</span><span class="n">formatstring</span><span class="p">,</span> <span class="n">block</span><span class="p">[:</span><span class="n">end</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="KFReader._get_data"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFReader._get_data">[docs]</a>    <span class="k">def</span> <span class="nf">_get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datablock</span><span class="p">,</span> <span class="n">vtype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract all data of a given type from a single data block. Returned value is a list of values (int, float, or bool) or a single &quot;bytes&quot; object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hlen</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sizes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">word</span><span class="p">]</span>
        <span class="n">i</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">datablock</span><span class="p">[:</span><span class="n">hlen</span><span class="p">],[(</span><span class="mi">4</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">word</span><span class="p">)])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">datablock</span><span class="p">[</span><span class="n">hlen</span><span class="p">:],</span> <span class="nb">zip</span><span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">b</span><span class="p">),(</span><span class="bp">self</span><span class="o">.</span><span class="n">word</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">word</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">contents</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># there won&#39;t be more than one chunk of data in any data block</span>
            <span class="k">if</span> <span class="n">vtype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">contents</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">vtype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">vtype</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">contents</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">vtype</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span><span class="n">contents</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Unknown vtype&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="KFReader._create_index"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFReader._create_index">[docs]</a>    <span class="k">def</span> <span class="nf">_create_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find and parse relevant index blocks of KFFile to extract the information about location of all sections and variables.</span>

<span class="sd">        Two dictionaries are populated during this process. ``_data`` contains, for each section, a list of triples describing how logical blocks of data are mapped into physical ones. For example, ``_data[&#39;General&#39;] = [(3,6,12), (9,40,45)]`` means that logical blocks 3-8 of section ``General`` are located in physical blocks 6-11 and logical blocks 9-13 in physical blocks 40-44. This list is always sorted via first tuple elements allowing efficient access to arbitrary logical block of each section.</span>

<span class="sd">        The second dictionary, ``_sections``, is used to locate each variable within its section. For each section, it contains another dictionary of each variable of this section. So ``_section[sec][var]`` contains all information needed to extract variable ``var`` from section ``sec``. This is a 4-tuple containing the following information: variable type, logic block in which the variable first occurs, position within this block where its data start and the length of the variable. Combining this information with mapping stored in ``_data`` allows to extract each single variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">hlen</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sizes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">word</span><span class="p">]</span>   <span class="c1">#length of index block header</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">superlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_block</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[(</span><span class="mi">32</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">),(</span><span class="mi">4</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">word</span><span class="p">)])</span>
            <span class="n">nextsuper</span> <span class="o">=</span> <span class="n">superlist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">while</span> <span class="n">nextsuper</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nsl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_block</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">nextsuper</span><span class="p">),</span> <span class="p">[(</span><span class="mi">32</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">),(</span><span class="mi">4</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">word</span><span class="p">)])</span>
                <span class="n">nextsuper</span> <span class="o">=</span> <span class="n">nsl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">superlist</span> <span class="o">+=</span> <span class="n">nsl</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1">#list of triples to convert logical to physical block numbers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sections</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pb</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="n">ty</span> <span class="ow">in</span> <span class="n">superlist</span><span class="p">:</span>   <span class="c1">#pb=physical block, lb=logical block, le=length, ty=type (3 for index, 4 for data)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;Latin-1&quot;</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;SUPERINDEX&#39;</span><span class="p">,</span> <span class="s1">&#39;EMPTY&#39;</span><span class="p">]:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="n">ty</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>   <span class="c1">#data block</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lb</span><span class="p">,</span> <span class="n">pb</span><span class="p">,</span> <span class="n">pb</span><span class="o">+</span><span class="n">le</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">ty</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>   <span class="c1">#index block</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sections</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_sections</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">le</span><span class="p">):</span>
                        <span class="n">indexblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_block</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">pb</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">indexblock</span><span class="p">[</span><span class="n">hlen</span><span class="p">:],[(</span><span class="mi">32</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">),(</span><span class="mi">6</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">word</span><span class="p">)])</span>
                        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">vlb</span><span class="p">,</span> <span class="n">vstart</span><span class="p">,</span> <span class="n">vlen</span><span class="p">,</span> <span class="n">_xx1</span><span class="p">,</span> <span class="n">vused</span><span class="p">,</span> <span class="n">vtype</span> <span class="ow">in</span> <span class="n">body</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                                <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;Latin-1&quot;</span><span class="p">)</span>
                            <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;EMPTY&#39;</span><span class="p">:</span> <span class="k">continue</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_sections</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vtype</span><span class="p">,</span> <span class="n">vlb</span><span class="p">,</span> <span class="n">vstart</span><span class="p">,</span> <span class="n">vused</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">lbs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">pbs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">lb</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="n">lbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span>
                    <span class="n">pbs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lbs</span><span class="p">,</span> <span class="n">pbs</span><span class="p">)</span></div>


<div class="viewcode-block" id="KFReader._datablocks"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFReader._datablocks">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_datablocks</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform a tuple of lists ``([x1,x2,...], [(a1,b1),(a2,b2),...])`` into an iterator over ``range(a1,b1)+range(a2,b2)+...`` Iteration starts from nth element of this list.&quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">bisect</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">first</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">first</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="n">lb</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">while</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="n">last</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">ret</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">ret</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span></div></div>



<span class="c1">#===========================================================================</span>
<span class="c1">#===========================================================================</span>
<span class="c1">#===========================================================================</span>



<div class="viewcode-block" id="KFFile"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFFile">[docs]</a><span class="k">class</span> <span class="nc">KFFile</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A class for reading and writing binary files in KF format.</span>

<span class="sd">    This class acts as a wrapper around |KFReader| collecting all the data written by user in some &quot;temporary zone&quot; and using Fortran binaries ``udmpkf`` and ``cpkf`` to write this data to the physical file when needed.</span>

<span class="sd">    The constructor argument *path* should be a string with a path to an existing KF file or a new KF file that you wish to create. If a path to existing file is passed, new |KFReader| instance is created allowing to read all the data from this file.</span>

<span class="sd">    When :meth:`~KFFile.write` method is used, the new data is not immediately written to a disk. Instead of that, it is temporarily stored in ``tmpdata`` dictionary. When method :meth:`~KFFile.save` is invoked, contents of that dictionary are written to a physical file and ``tmpdata`` is emptied.</span>

<span class="sd">    Other methods like :meth:`~KFFile.read` or :meth:`~KFFile.delete_section` are aware of ``tmpdata`` and work flawlessly, regardless if :meth:`~KFFile.save` was called or not.</span>

<span class="sd">    By default, :meth:`~KFFile.save` is automatically invoked after each :meth:`~KFFile.write`, so physical file on a disk is always &quot;actual&quot;. This behavior can be adjusted with *autosave* constructor parameter. Having autosave enabled is usually a good idea, however, if you need to write a lot of small pieces of data to your file, the overhead of calling ``udmpkf`` and ``cpkf`` after *every* :meth:`~KFFile.write` can lead to significant delays. In such a case it is advised to disable autosave and call :meth:`~KFFile.save` manually, when needed.</span>

<span class="sd">    Dictionary-like bracket notation can be used as a shortcut to read and write variables::</span>

<span class="sd">        mykf = KFFile(&#39;someexistingkffile.kf&#39;)</span>
<span class="sd">        #all three below are equivalent</span>
<span class="sd">        x = mykf[&#39;General%Termination Status&#39;]</span>
<span class="sd">        x = mykf[(&#39;General&#39;,&#39;Termination Status&#39;)]</span>
<span class="sd">        x = mykf.read(&#39;General&#39;,&#39;Termination Status&#39;)</span>

<span class="sd">        #all three below are equivalent</span>
<span class="sd">        mykf[&#39;Geometry%xyz&#39;] = somevariable</span>
<span class="sd">        mykf[(&#39;Geometry&#39;,&#39;xyz&#39;)] = somevariable</span>
<span class="sd">        mykf.write(&#39;Geometry&#39;,&#39;xyz&#39;, somevariable)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_types</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span> <span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="s1">&#39;</span><span class="si">%10i</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">x</span><span class="p">),</span>
            <span class="nb">float</span> <span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="s1">&#39;</span><span class="si">%26.16e</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">x</span><span class="p">),</span>
              <span class="nb">str</span> <span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="nb">chr</span><span class="p">(</span><span class="mi">255</span><span class="p">))),</span> <span class="c1"># in the ascii representation of a kf, &#39;\n&#39; (ascii #10) is concoded as &#39;&#39; (ascii #255)</span>
             <span class="nb">bool</span> <span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;T&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="s1">&#39;F&#39;</span><span class="p">)}</span>


<div class="viewcode-block" id="KFFile.__init__"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFFile.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">autosave</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autosave</span> <span class="o">=</span> <span class="n">autosave</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">KFReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="KFFile.read"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFFile.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">return_as_list</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract and return data for a *variable* located in a *section*.</span>

<span class="sd">        By default, for single-value numerical or boolean variables returned value is a single number or bool. For longer variables this method returns a list of values. For string variables a single string is returned. This behavior can be changed by setting *return_as_list* parameter to ``True``. In that case the returned value is always a list of numbers (possibly of length 1) or a single string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span> <span class="ow">and</span> <span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span><span class="p">[</span><span class="n">section</span><span class="p">]:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">variable</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_as_list</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">bool</span><span class="p">)):</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="p">[</span><span class="n">ret</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="KFFile.write"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFFile.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a *variable* with a *value* in a *section* . If such a variable already exists in this section, the old value is overwritten.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="nb">bool</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Trying to store improper value in KFFile&#39;</span><span class="p">)</span>
        <span class="n">trick_value</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">value_type</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot store empty lists in KFFile without a type&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span>  <span class="n">value_type</span> <span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
                <span class="n">trick_value</span><span class="o">=</span><span class="p">{}</span>
                <span class="n">trick_value</span><span class="p">[</span><span class="s1">&#39;empty_list_type&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">value_type</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">value</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Lists stored in KFFile must have all elements of the same type&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="nb">bool</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Only lists of int, float, str or bool can be stored in KFFile&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            
        <span class="k">if</span> <span class="n">trick_value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">trick_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autosave</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>


<div class="viewcode-block" id="KFFile.save"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFFile.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save all changes stored in ``tmpdata`` to physical file on a disk.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">newvars</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span><span class="p">[</span><span class="n">section</span><span class="p">]:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">variable</span><span class="p">]</span>
                    <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">KFFile</span><span class="o">.</span><span class="n">_str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                    <span class="n">newvars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="o">+</span><span class="s1">&#39;%&#39;</span><span class="o">+</span><span class="n">variable</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

            <span class="n">tmpfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;.tmp&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
            <span class="n">saferun</span><span class="p">([</span><span class="s1">&#39;udmpkf&#39;</span><span class="p">,</span> <span class="n">tmpfile</span><span class="p">],</span> <span class="nb">input</span><span class="o">=</span><span class="n">txt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;iso8859&#39;</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">:</span>
                <span class="n">saferun</span><span class="p">([</span><span class="s1">&#39;cpkf&#39;</span><span class="p">,</span> <span class="n">tmpfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">]</span> <span class="o">+</span> <span class="n">newvars</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">KFReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="KFFile.delete_section"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFFile.delete_section">[docs]</a>    <span class="k">def</span> <span class="nf">delete_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the entire *section* from this KF file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">_sections</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">_create_index</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">_sections</span><span class="p">:</span>
                <span class="n">tmpfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;.tmp&#39;</span>
                <span class="n">saferun</span><span class="p">([</span><span class="s1">&#39;cpkf&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">tmpfile</span><span class="p">,</span> <span class="s1">&#39;-rm&#39;</span><span class="p">,</span> <span class="n">section</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">KFReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="KFFile.sections"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFFile.sections">[docs]</a>    <span class="k">def</span> <span class="nf">sections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list with all section names, ordered alphabetically.&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">_sections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">_create_index</span><span class="p">()</span>
            <span class="n">ret</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">_sections</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="KFFile.read_section"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFFile.read_section">[docs]</a>    <span class="k">def</span> <span class="nf">read_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a dictionary with all variables from a given *section*.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Some sections can contain very large amount of data. Turning them into dictionaries can cause memory shortage or performance issues. Use this method carefully.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sec</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sec</span> <span class="o">==</span> <span class="n">section</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;WARNING: Section &#39;</span><span class="si">{}</span><span class="s2">&#39; not present in </span><span class="si">{}</span><span class="s2"> or present, but empty. Returning empty dictionary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="KFFile.keys"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFFile.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Returns all sections in the current instance &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">([</span><span class="n">sec</span> <span class="k">for</span> <span class="n">sec</span><span class="p">,</span><span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">])</span></div>

<div class="viewcode-block" id="KFFile.get_skeleton"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFFile.get_skeleton">[docs]</a>    <span class="k">def</span> <span class="nf">get_skeleton</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a dictionary reflecting the structure of this KF file. Each key in that dictionary corresponds to a section name of the KF file with the value being a set of variable names.&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sec</span><span class="p">,</span><span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">[</span><span class="n">sec</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">sec</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="KFFile.__getitem__"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFFile.__getitem__">[docs]</a>    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow to use ``x = mykf[&#39;section%variable&#39;]`` or ``x = mykf[(&#39;section&#39;,&#39;variable&#39;)]`` instead of ``x = kf.read(&#39;section&#39;, &#39;variable&#39;)``.&quot;&quot;&quot;</span>
        <span class="n">section</span><span class="p">,</span> <span class="n">variable</span> <span class="o">=</span> <span class="n">KFFile</span><span class="o">.</span><span class="n">_split</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span></div>


<div class="viewcode-block" id="KFFile.__setitem__"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFFile.__setitem__">[docs]</a>    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow to use ``mykf[&#39;section%variable&#39;] = value`` or ``mykf[(&#39;section&#39;,&#39;variable&#39;)] = value`` instead of ``kf.write(&#39;section&#39;, &#39;variable&#39;, value)``.&quot;&quot;&quot;</span>
        <span class="n">section</span><span class="p">,</span> <span class="n">variable</span> <span class="o">=</span> <span class="n">KFFile</span><span class="o">.</span><span class="n">_split</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="KFFile.__iter__"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFFile.__iter__">[docs]</a>    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iteration yields pairs of section name and variable name.&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sec</span><span class="p">,</span><span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">sec</span><span class="p">,</span><span class="n">var</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdata</span><span class="p">[</span><span class="n">sec</span><span class="p">]:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">sec</span><span class="p">,</span><span class="n">var</span><span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">i</span></div>


<div class="viewcode-block" id="KFFile.__contains__"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFFile.__contains__">[docs]</a>    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implements Python ``in`` operator for KFFiles. *arg* can be a single string with a section name or a pair of strings (section, variable).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;in &lt;KFFile&gt;&#39; requires string of a pair of strings as left operand&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="KFFile._split"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFFile._split">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_split</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure that a key used in bracket notation is of the form ``&#39;section%variable&#39;`` or ``(&#39;section&#39;,&#39;variable&#39;)``. If so, return a tuple ``(&#39;section&#39;,&#39;variable&#39;)``.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Improper key used in KFFile dictionary-like notation&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="KFFile._str"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFFile._str">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_str</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation of *val* in the form that can be understood by ``udmpkf``.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
            <span class="n">valtype</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;empty_list_type&#39;</span><span class="p">]</span>
            <span class="n">val</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="nb">bool</span><span class="p">,</span><span class="nb">float</span><span class="p">)):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">valtype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">valtype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">t</span><span class="p">,</span><span class="n">step</span><span class="p">,</span><span class="n">f</span> <span class="o">=</span> <span class="n">KFFile</span><span class="o">.</span><span class="n">_types</span><span class="p">[</span><span class="n">valtype</span><span class="p">]</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">valtype</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="c1">#udmpkf reads 160 characters per variable, split over max. 80 per line, to make a string array</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span> <span class="o">*</span> <span class="mi">160</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">splitstrings</span> <span class="o">=</span> <span class="p">[[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">80</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="mi">80</span><span class="p">:</span><span class="mi">160</span><span class="p">]]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">splitstrings</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10i%10i%10i</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ret</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="n">f</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">ret</span></div></div>


<span class="c1">#===========================================================================</span>
<span class="c1">#===========================================================================</span>
<span class="c1">#===========================================================================</span>



<div class="viewcode-block" id="KFHistory"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFHistory">[docs]</a><span class="k">class</span> <span class="nc">KFHistory</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A class for reading &quot;History&quot; sections of files in the KF format.</span>

<span class="sd">    This class acts as a wrapper around |KFReader| enabling convenient iteration over entries (frames) of History sections.</span>

<span class="sd">    The constructor argument *kf* should be a |KFReader| instance attached to an existing KF file. The *section* argument then holds a name of the desired History-like section, such as &quot;History&quot; or &quot;MDHistory&quot;.</span>

<span class="sd">    The :meth:`~KFHistory.read_all` method can be used used to easily read all values of a particular history item into a single numpy array.</span>

<span class="sd">    To iterate over the frames in a history section, use :meth:`~KFHistory.iter` or :meth:`~KFHistory.iter_optional`. The former raises an exception if the selected variable is not present in the history, while the latter returns a given default value instead.</span>

<span class="sd">    Usage::</span>

<span class="sd">        kf = KFReader(&#39;somefile.rkf&#39;)</span>
<span class="sd">        mdhistory = KFHistory(kf, &#39;MDHistory&#39;)</span>

<span class="sd">        for T, p in mdhistory.iter(&#39;Temperature&#39;), mdhistory.iter_optional(&#39;Pressure&#39;, 0):</span>
<span class="sd">            print(T, p)</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="KFHistory.__init__"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFHistory.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kf</span><span class="p">,</span> <span class="n">section</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kf</span> <span class="o">=</span> <span class="n">kf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">section</span> <span class="o">=</span> <span class="n">section</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">=</span> <span class="n">kf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;nEntries&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shapes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocked</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;nBlocks&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">kf</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nblocks</span> <span class="o">=</span> <span class="n">kf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;nBlocks&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nblocks</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="KFHistory.read_all"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFHistory.read_all">[docs]</a>    <span class="k">def</span> <span class="nf">read_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a numpy array containing the values of history item *name* from all frames.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_shape</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocked</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nblocks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">kf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span></div>

<div class="viewcode-block" id="KFHistory.iter"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFHistory.iter">[docs]</a>    <span class="k">def</span> <span class="nf">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over the values of history item *name*.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_shape</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocked</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nblocks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield from</span> <span class="n">block</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="c1"># one-element blocks are not iterable (KFReader returns them as scalars)</span>
                    <span class="k">yield</span> <span class="n">block</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">kf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span></div>

<div class="viewcode-block" id="KFHistory.iter_optional"><a class="viewcode-back" href="../../../../interfaces/kffiles.html#scm.plams.tools.kftools.KFHistory.iter_optional">[docs]</a>    <span class="k">def</span> <span class="nf">iter_optional</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over the values of history item *name*, returning *default* if the item is not present.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;(1)&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kf</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">default</span></div>

    <span class="k">def</span> <span class="nf">_init_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">shapevar</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;(dim)&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">shapevar</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kf</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">shapevar</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># shape is a list (variable &quot;name&quot; is at least rank-2)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># shape is a scalar (variable &quot;name&quot; is a scalar or rank-1)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">,)</span>
            <span class="n">perAtomVar</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;(perAtom)&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nblocks</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">perAtomVar</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kf</span><span class="p">:</span>
                <span class="n">perAtom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="n">perAtomVar</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">perAtom</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">blocked</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># no shape info =&gt; assume scalar/rank-1 (read as is, no blocks)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span></div>
</pre></div>

           </div>
          </div>
          <!--STARTNOSOLR-->
<footer>
  

  <hr/> 

<!-- start :: footer -->
		<footer class="site-footer block">
			<div class="container">
				<div class="row">
					<div class="footer-column" >
	<ul>
		<li id="nav_menu-2" class="widget widget_nav_menu "><h3>Application Areas</h3><div class="menu-application-areas-container"><ul id="menu-application-areas" class="menu">
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/batteries/">Batteries &#038; PVs</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/chemical-bonding-analysis/">Bonding Analysis</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/catalysis/">Catalysis</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/heavy-elements/">Heavy Elements</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/inorganic-chemistry/">Inorganic Chemistry</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/pharma/">Life Sciences</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/materials-science/">Materials Science</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/nanotechnology/">Nanotechnology</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/oil-and-gas/">Oil and Gas</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/organic-electronics/">Organic Electronics</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/polymers/">Polymers</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/spectroscopy/">Spectroscopy</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/applications/teaching/">Teaching</a></li>
</ul></div></li>	</ul>
</div><div class="footer-column" >
	<ul>
		<li id="nav_menu-7" class="widget widget_nav_menu "><h3>Products</h3><div class="menu-product-navigation-container"><ul id="menu-product-navigation" class="menu">
<li id="menu-item-40263" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-40263"><a href="https://www.scm.com/product/ams/">AMS Driver</a></li>
<li id="menu-item-7235" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-7235"><a href="https://www.scm.com/product/adf/">ADF</a></li>
<li id="menu-item-7236" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-7236"><a href="https://www.scm.com/product/band_periodicdft/">BAND</a></li>
<li id="menu-item-7237" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-7237"><a href="https://www.scm.com/product/cosmo-rs/">COSMO-RS</a></li>
<li id="menu-item-7238" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-7238"><a href="https://www.scm.com/product/dftb/">DFTB</a></li>
<li id="menu-item-7239" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-7239"><a href="https://www.scm.com/product/gui/">GUI</a></li>
<li id="menu-item-44383" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-44383"><a href="https://www.scm.com/product/machine-learning-potentials/">MLPotential</a></li>
<li id="menu-item-7240" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-7240"><a href="https://www.scm.com/product/mopac/">MOPAC</a></li>
<li id="menu-item-40262" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-40262"><a href="https://www.scm.com/product/plams/">PLAMS</a></li>
<li id="menu-item-43701" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-43701"><a href="https://www.scm.com/product/quantum-espresso/">Quantum ESPRESSO</a></li>
<li id="menu-item-7241" class="menu-item menu-item-type-post_type menu-item-object-product menu-item-7241"><a href="https://www.scm.com/product/reaxff/">ReaxFF</a></li></ul></div></li><li id="nav_menu-26" class="widget widget_nav_menu "><div class="menu-licensing-container"><ul id="menu-licensing" class="menu"><li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/pricing-licensing/">Pricing &#038; Licensing</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/pricing-licensing/price-quote/">Price Quote</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/pricing-licensing/price-quote/calculate-your-price/">Price Calculator</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/consulting/">Scientific Consulting</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/pricing-licensing/adf-resellers/">Resellers</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/pricing-licensing/scm-license-terms/">License Terms</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/pricing-licensing/ordering-procedure/">Ordering</a></li>
</ul></div></li>	</ul>
</div><div class="footer-column" >
	<ul>
		<li id="nav_menu-6" class="widget widget_nav_menu "><h3>Support</h3><div class="menu-support-navigation-container"><ul id="menu-support-navigation" class="menu"><li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/support/">Support Overview</a></li>
<li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.scm.com/support/ams-installation-videos/">Installation</a></li>
<li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.scm.com/support/ams-tutorials-and-manuals/">Documentation</a></li>
<li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.scm.com/doc/Tutorials/GUI_overview/GUI_overview_tutorials.html">GUI Tutorials</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/support/downloads/">Downloads</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/faq/">FAQs</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/adf-discussion-list/">Discussion List</a></li>
<li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.scm.com/support/documentation-previous-versions/release-notes/">Release Notes</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/support/adf-teaching-materials/">Teaching Materials</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/news-agenda/adf-hands-on-workshops/">Workshops</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/news-agenda/web-presentations-by-adf-experts/">Webinars</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/videos-tutorials-and-web-presentations/">Videos</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/amsterdam-modeling-suite/brochures/">Brochure</a></li>
<li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.scm.com/amsterdam-modeling-suite/research-papers-citing-adf/">Papers Citing ADF</a></li>
<li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.scm.com/category/highlights/">Literature Highlights</a></li>
</ul></div></li>	</ul>
</div><div class="footer-column" >
	<ul>
		<li id="nav_menu-28" class="widget widget_nav_menu "><h3>About Us</h3><div class="menu-about-us-container"><ul id="menu-about-us" class="menu"><li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/contact-us/">Contact Us</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/eu-projects/">EU Projects</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/our-authors/">Contributors</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/our-people/">The SCM Team</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/collaborations/">Collaborations</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/careers/">Careers</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/mission-vision/">Mission &#038; Vision</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/newsletters/">Newsletters</a></li>
<li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.scm.com/category/news/">News</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://www.scm.com/about-us/news-agenda/">Events</a></li>
</ul></div></li>	</ul>
</div><div class="footer-column" >
	<ul>
			</ul>
</div>				</div>
			</div>
		</footer>
		<footer class="disclaimer-footer">
			<img src="https://www.scm.com/wp-content/themes/scm/images/logos/scm-logo-compact.svg" alt="">
			<nav class="menu-service-navigation-container"><ul id="menu-service-navigation" class="menu-service navbar-nav"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-73"><a href="https://www.scm.com/copyright/">Copyright</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-72"><a href="https://www.scm.com/terms-of-use/">Terms of Use</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-privacy-policy menu-item-71"><a href="https://www.scm.com/privacy-policy/">Privacy Policy</a></li>
</ul></nav></footer>	
		<!-- end :: footer -->

<!--ENDNOSOLR-->
        </div>
      </div>

    </section>
  </div>
  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'2021.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCRWHZZ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../../_static/language_data.js"></script>
      <script type="text/javascript" src="../../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.js"></script>
      <script type="text/javascript" src="../../../../_static/sphinx_tabs/tabs.js"></script>
      <script type="text/javascript" src="../../../../_static/../../MathJax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>