
.. _FQQM: 
.. index:: FQ/QM 
.. index:: QM/FQ
.. index:: QM/MM
.. index:: solvent effects


QM/FQ: Quantum Mechanics/Fluctuating Charges (and Fluctuating Dipoles)
======================================================================

The Quantum Mechanics/Fluctuating Charges (QM/FQ) and QM/FQ and Fluctuating Dipoles (QM/FQFμ) methods are multiscale models designed to describe the properties of a chemical system perturbed by the presence of its molecular environment, where the latter described using a polarizable classical force-field, see for example Refs. [#ref1]_ [#ref2]_  [#ref3]_ [#ref4]_ [#ref5]_.
The QM/FQ model has been applied to the calculation of spectroscopic properties of molecules in aqueous solution and different solvents (see [#ref6]_), whereas QM/FQFμ has only been applied to aqueous solutions.
In QM/FQ each atom of the environment (e.g. a solvation shell) is endowed with a fluctuating charge (FQ) which can vary in response to the electrostatic potential generated by the solute, whereas in QM/FQFμ an additional source of polarization (an induced dipole moment) is placed on each atom.
The FQ and FQFμ charges can be constrained such that each molecule within the environment remains electrically neutral.
The energy functional of the FQ and FQFμ systems can be written as:

.. math::

  F(q,\lambda) = \sum_{\alpha, i} q_{\alpha, i} \chi_{\alpha, i} + 1/2\sum_{i\alpha j\beta} q_{\alpha, i} T^{qq}_{\alpha i, \beta j} q_{\beta, j} + \sum_{\alpha}\lambda_\alpha (\sum_i q_{\alpha, i} - Q_\alpha)

.. math::

  F(q,\mu,\lambda) = \frac{1}{2}\sum_{i\alpha j\beta} q_{i\alpha}{\text{T}_{i\alpha,j\beta}^{qq}}q_{j\beta} +\frac{1}{2}\sum_{ij}\mu_{i\alpha}^{\dagger}\mathbf{T}_{i\alpha,j\beta}^{\mu\mu}{\mu}_{j\beta} + \sum_{ij}q_{i\alpha}\textbf{T}_{i\alpha,j\beta}^{q\mu}{\mu}_{j\beta}^{\dagger} + \sum_{i\alpha}q_{i\alpha}\chi_{i\alpha} + \sum_{\alpha}\lambda_{\alpha}\left[\sum_{i} q_{\alpha i}-Q_{\alpha}\right] 

where :math:`q_{\alpha, i}` and :math:`\mu_{\alpha, i}` are the i-th FQ charge and the i-th dipole belonging to the :math:`\alpha`-th molecule, :math:`\chi_{\alpha,i}` is the electronegativity of each atom, :math:`\lambda_\alpha` is the Lagrange multiplier associated with the :math:`\alpha`-th molecule, whose purpose is to fix the total charge to be :math:`Q_\alpha`. 
The matrix :math:`T^{qq}_{\alpha i, \beta j}` describes the interaction kernel between the charges: while the diagonal elements are related to the self-interaction through the chemical hardnesses :math:`eta`, the off-diagonal elements may be specified through different formulations. The :math:`T_{i\alpha,j\beta}^{q\mu}` and :math:`T_{i\alpha,j\beta}^{\mu\mu}` matrices describe the interaction kernel between charges and dipoles and between the dipoles, respectively. 
The electric variables (the FQ charges and the dipoles) can be obtained by minimizing the energy functional with respect to the charges, the dipoles and the Lagrange multipliers, which leads to the following set of linear equations:

.. math::
  \left(\begin{array}{cc|c}
  \mathbf{T}^{qq} & \mathbf{1}_{{\lambda}} & \mathbf{T}^{q\mu} \\
  \mathbf{1}^{\dagger}_{{\lambda}} & \mathbf{0} & \mathbf{0}   \\
  \hline
  -\mathbf{T}^{q\mu^{\dagger}} & \mathbf{0} & \mathbf{T}^{\mu\mu}
  \end{array}
  \right)
  \left({\begin{array}{c}
  \mathbf{q}\\
  {\lambda}\\
  \hline
  {\mu}
  \end{array}}\right)
  =
  \left(\begin{array}{c} -{\chi} \\
  \mathbf{Q} \\ \hline
  \mathbf{0}
  \end{array}\right)
  \qquad \Rightarrow \qquad
  \mathbf{D}\mathbf{Q}_{\lambda} = -\mathbf{C}_Q

where :math:`\mathbf{1}_{{\lambda}}` is a rectangular matrix which accounts for the Lagrangians, :math:`\mathbf{C}_Q` is a vector containing atomic electronegativities and total charge constraints. :math:`\mathbf{Q}_\lambda` is a vector containing charges, dipoles and Lagrange multipliers.

The coupling of the FQ/FQFμ models with a QM Hamiltonian can be done by introducing the QM/FQ(Fμ) interaction operator as

.. math::
    
  H_\text{QM/FQ} = \sum_i^{N} q_i V[\rho](r_i),
  H_{\text{QM/FQF}\mu} = \sum_i^{N} q_i V[\rho](r_i) - \sum_i^{N} \mu_i E[\rho](r_i),

where :math:`N` is the number of atoms, :math:`q_i` and :math:`\mu_i` are the i-th FQ charge and dipole located at position :math:`r_i`, respectively. :math:`V[\rho](r_i)` and :math:`E[\rho](r_i)` are the electric potential and field generated by the QM system on the same point.
The introduction of the QM/FQ interaction leads to a modified set of linear equations for the FQ charges, i.e.

.. math::
  
  DQ_\lambda = -C_Q-R[\rho]

where R is an array collecting the electric potential and field generated by the QM electrons and nuclei at the position of each atom.
The FQ charges (and dipoles) are thus determined self-consistently along with the ground-state density.
Since the charges (and dipoles) depend on the QM density, explicit terms also appear within response equations that are solved to simulate spectroscopic and excited-state properties of the QM system.

Starting from AMS2021.103 a screening is included for the interaction between MM atoms and the QM density, to avoid unstable results in case numerical integration points are accidentally close to MM atoms.
The screened :math:`1/r_{ij}` has the form:

.. math::

  \text{ERF: =}  & \frac{erf(ar_{ij})}{r_{ij}} \\
  \text{EXP: =}  & \frac{(1-exp(-ar_{ij}))^2}{r_{ij}} \\
  \text{GAUS: =} & \frac{erf(r_{ij}/a)}{r_{ij}}


where :math:`a` can be changed with the QMSCREENFACTOR keyword.


Coupling with FDE
^^^^^^^^^^^^^^^^^

Starting from AMS2022 the coupling between :ref:`Frozen Density Embedding (FDE)<FDE>` and FQ is implemented (see Ref. [#ref7]_).
When a FDE calculation is setup, the FQ(Fμ)vironment atoms respond to both layers of the FDE embedding.

In the case of an excited-state calculation performed with the Time-Dependent DFT method (TDDFT), the atoms belonging to the frozen density layer do not normally respond dynamically to the external field.
This can create an imbalance because both the non-frozen QM layer and the fluctuating charge (and dipole) layer both do.
As a very cost-effective way to include the response of the frozen-density layer into the calculation is to use the FQ(Fμ) model to estimate it (see Ref. [#ref7]_ for more details) provided the parameters defining the molecular entities in the frozen layer are available.

This can be accomplished by simply including the FDERESP keyword in the input (see below).



Input options
-------------

.. _keyscheme FQQM:

.. scmautodoc:: adf FQQM

.. _keyscheme FQPAR:

::


  FQPAR
    Element
      CHI value
      ETA value
      ALPHA value
    SUBEND
    GROUP groupname
      natoms
        elem x.xxx y.yyy z.zzz 
        elem x.xxx y.yyy z.zzz 
        elem x.xxx y.yyy z.zzz 
        ...
    SUBEND
  END

``Element``
  Within the FQPAR block, you will need a sub-block that defines the parameters for each element that is in your FQ/FQFμ system. You will need to replace 'Element' with the element you are assigning parameters to, as in::

    Na
      ...
    SUBEND

  if you are assigning parameters to Na.  Note that the first letter MUST be capitalized and the second MUST be lowercase. 
  
  ``CHI value``
    CHI specifies the atomic electronegativity (in a.u.)

  ``ETA value``
    ETA specifies the chemical hardness (in a.u.)

  ``ALPHA value``
    ALPHA specifies the atomic polarizability (only for QM/FQFμ, in a.u.)

  In case of water recommended is to use the optimized FQ parameters CHI and ETA for O and H in water proposed in Ref. [#ref9]_ ::

    O
      CHI 0.189194
      ETA 0.523700
    SUBEND
    H
      CHI 0.012767
      ETA 0.537512
    SUBEND

  Alternatively, in case of water as solvent, one could use the parameters proposed in Ref. [#ref10]_ ::

    O
      CHI 0.116859
      ETA 0.584852
    SUBEND
    H
      CHI 0.000001
      ETA 0.625010
    SUBEND
  
  For other solvents, it is recommended to use the parameters reported in Ref. [#ref6]_.

  For QM/FQFμ calculations for water as solvent, the parameters reported in Ref. [#ref4]_ can be used ::

    O
      CHI   0.290840
      ETA   0.562510
      ALPHA 2.218790
    SUBEND        
    H             
      CHI   0.167570
      ETA   0.609320
      ALPHA 1.190640
    SUBEND

``GROUP groupname``
  The GROUP sub-block is where the FQ atom coordinates are given. A (unique) groupname is required (maximum 10 characters).

  Example for a water molecule::

     GROUP water1
       3
       O  0.00000  0.00000  0.59372 
       H  0.00000  0.76544 -0.00836 
       H  0.00000 -0.76544 -0.00836 
     SUBEND

  The first line gives the number of atoms to follow. Every line after that contains the element in the first column (first letter MUST be capitalized, second MUST be lowercase), then the x-component, then the y-component, then the z-component. The parameters for each element should have been defined in the 'Element' sub-block at the beginning of the FQPAR section.

.. only:: html

  .. rubric:: References

.. [#ref1] T.\  Giovannini, F. Egidi, C. Cappelli, *Molecular spectroscopy of aqueous solutions: a theoretical perspective*, `Chemical Society Reviews, 49, 5664 (2020) <https://doi.org/10.1039/C9CS00464E>`__

.. [#ref2] C.\  Cappelli, *Integrated QM/polarizable MM/continuum approaches to model chiroptical properties of strongly interacting solute–solvent systems*, `International Journal of Quantum Chemistry, 116, 1532 (2016) <https://doi.org/10.1002/qua.25199>`__

.. [#ref3] T.\  Giovannini, F. Egidi, C. Cappelli, *Theory and algorithms for chiroptical properties and spectroscopies of aqueous systems*, `Physical Chemical Chemical Physics, 22, 22864 (2020) <https://doi.org/10.1039/D0CP04027D>`__

.. [#ref4] T.\  Giovannini, A. Puglisi, M. Ambrosetti, C. Cappelli, *Polarizable QM/MM approach with fluctuating charges and fluctuating dipoles: the QM/FQFμ model*, `Journal of Chemical Theory and Computation, 15, 2233-2245 (2019) <https://doi.org/10.1021/acs.jctc.8b01149>`__

.. [#ref5] T.\ Giovannini, R. R. Riso, M. Ambrosetti, A. Puglisi, C. Cappelli, *Electronic transitions for a fully polarizable QM/MM approach based on fluctuating charges and fluctuating dipoles: linear and corrected linear response regimes*, `The Journal of Chemical Physics, 151, 174104 (2019) <https://doi.org/10.1063/1.5121396>`__

.. [#ref6] M.\ Ambrosetti, S. Skoko, T. Giovannini, C. Cappelli, *Quantum Mechanics/Fluctuating Charge Protocol to Compute Solvatochromic Shifts*, `Journal of Chemical Theory and Computation (2021) <https://doi.org/10.1021/acs.jctc.1c00763>`__

.. [#ref7] F.\ Egidi, S. Angelico, P. Lafiosca, T. Giovannini, C. Cappelli, *A polarizable three-layer frozen density embedding/molecular mechanics approach*, `The Journal of Chemical Physics, 154, 164107 (2021) <https://doi.org/10.1063/5.0045574>`__

.. [#ref8] K.\  Ohno, *Some remarks on the Pariser-Parr-Pople method*, `Theoretica Chimica Acta, 2, 219 (1964) <https://doi.org/10.1007/BF00528281>`__

.. [#ref9] T.\  Giovannini, P. Lafiosca, B. Chandramouli, V. Barone, C. Cappelli, *Effective yet reliable computation of hyperfine coupling constants in solution by a QM/MM approach: Interplay between electrostatics and non-electrostatic effects*, `Journal of Chemical Physics 150 (2019) 124102 <https://doi.org/10.1063/1.5080810>`__

.. [#ref10] S.W. Rick, S.J. Stuart, B.J. Berne, *Dynamical fluctuating charge force fields: Application to liquid water*, `Journal of Chemical Physics 101 (1994) 6141 <https://doi.org/10.1063/1.468398>`__
